<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <!-- 
    To enable Figma's official theme colors, call figma.showUI() with themeColors: true
    Example: figma.showUI(__html__, { themeColors: true });
    This will inject the official CSS variables and add figma-light/figma-dark classes
  -->
  <style id="figma-style">
    /* This style tag will be populated by Figma with CSS variables */
  </style>
  <script>
    // Debug theme injection
    console.log('Plugin UI loaded');
    
    // Figma handles all theme switching automatically via CSS variables
    // No JavaScript observers or processing needed!
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;550;600&display=swap" rel="stylesheet">
  <style>
    /* Figma Plugin UI - Official Design System Integration */
    :root {
      /* Color tokens are automatically injected by Figma when themeColors: true */
      /* We only define typography, spacing, and other non-color tokens here */
      
      /* Typography - Figma UI3 Scale */
      --figma-font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      --figma-font-size-11: 11px;
      --figma-font-size-12: 12px;
      --figma-font-size-14: 14px;
      --figma-font-size-16: 16px;
      --figma-line-height-16: 1.45;
      --figma-line-height-20: 1.43;
      --figma-font-weight-normal: 400;
      --figma-font-weight-medium: 500;
      --figma-font-weight-semibold: 600;
      
      /* Spacing - Figma UI3 8px Grid */
      --figma-space-4: 4px;
      --figma-space-8: 8px;
      --figma-space-12: 12px;
      --figma-space-16: 16px;
      --figma-space-20: 20px;
      --figma-space-24: 24px;
      
      /* Border Radius */
      --figma-radius-4: 4px;
      --figma-radius-6: 6px;
      --figma-radius-8: 8px;
      
      /* Shadows */
      --figma-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --figma-shadow-md: 0 2px 4px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
      --figma-shadow-brand: 0 0 0 3px rgba(13, 153, 255, 0.1);
    }

    /* Base Styles */
    body { 
      font: var(--figma-font-size-12)/var(--figma-line-height-16) var(--figma-font-family); 
      margin: 0; 
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    h1 { 
      font-size: var(--figma-font-size-14); 
      font-weight: var(--figma-font-weight-semibold);
      margin: 0 0 var(--figma-space-16) 0; 
      display: flex; 
      align-items: center;
      color: var(--figma-color-text);
    }
    
    #scanResultsView h1 {
      justify-content: space-between;
      padding-bottom: 0;
      margin-bottom: 0;
    }

    #scanResultsView.view.active {
      padding-bottom: 40px;
      padding-top: 0;
    }
    
    .back-btn { 
      background: none;
      border: none;
      color: var(--figma-color-icon);
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      outline: none;
      box-shadow: none;
      margin-right: var(--figma-space-8);
      width: auto;
      height: auto;
    }

    .back-btn svg {
      width: 24px;
      height: 24px;
    }
    
    .back-btn:hover { 
      background: var(--figma-color-bg-hover); 
      color: var(--figma-color-icon-secondary);
      box-shadow: none;
    }
    
    #settingsView h1 svg {
    }
    
    button { 
      width: 100%; 
      padding: var(--figma-space-8) var(--figma-space-12); 
      font: inherit; 
      font-weight: var(--figma-font-weight-medium);
      background: var(--figma-color-bg-brand); 
      color: var(--figma-color-text-onbrand); 
      border: none; 
      border-radius: var(--figma-radius-6); 
      cursor: pointer; 
      margin: var(--figma-space-4) 0;
      transition: box-shadow 0.15s ease, transform 0.15s ease;
      box-shadow: var(--figma-shadow-sm);
    }
    
    button:hover { 
      background: var(--figma-color-bg-brand-hover); 
      box-shadow: var(--figma-shadow-md);
    }
    
    button:active {
      background: var(--figma-color-bg-brand-pressed);
    }
    
    button:focus {
      outline: none;
      box-shadow: var(--figma-shadow-brand);
    }
    
    .library-item, .component-item { 
      padding: var(--figma-space-12); 
      margin: var(--figma-space-4) var(--figma-space-16); 
      background: var(--figma-color-bg); 
      border: 1px solid var(--figma-color-border); 
      border-radius: var(--figma-radius-6); 
       
      display: flex; 
      align-items: center;
      box-shadow: var(--figma-shadow-sm);
    }
    
    .library-item { cursor: default; }
    .component-item { cursor: default; }
    

    

    
    .library-section-header { 
      font-weight: var(--figma-font-weight-semibold); 
      margin: var(--figma-space-20) 0 var(--figma-space-8) 0; 
      color: var(--figma-color-text-secondary); 
      font-size: var(--figma-font-size-11); 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      border-bottom: 1px solid var(--figma-color-border); 
      padding-bottom: var(--figma-space-4); 
    }
    
    .scan-results-header { 
      font-weight: var(--figma-font-weight-semibold); 
      margin-bottom: var(--figma-space-16); 
      font-size: var(--figma-font-size-14); 
      color: var(--figma-color-text);
    }
    
    .swap-all-container { 
      margin-top: var(--figma-space-24); 
      padding-top: var(--figma-space-16); 
      border-top: 1px solid var(--figma-color-border); 
    }
    
    .swap-all-btn { 
      width: 100%; 
      padding: var(--figma-space-12) var(--figma-space-16); 
      font-size: var(--figma-font-size-14); 
      font-weight: var(--figma-font-weight-semibold); 
      background: var(--figma-color-bg-success); 
      color: var(--figma-color-text-onbrand); 
      border: none; 
      border-radius: var(--figma-radius-6); 
      cursor: pointer; 
      
      box-shadow: var(--figma-shadow-sm);
    }
    
    .swap-all-btn:hover { 
      background: var(--figma-color-bg-success-hover); 
      box-shadow: var(--figma-shadow-md);
    }
    
    /* Settings styles */
    #settingsView { 
      padding: 0;
    }

    #settingsView h1 {
    }

    .settings-content {
      display: flex;
      flex-direction: column;
      padding: 0;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: var(--figma-space-16) var(--figma-space-8);
      gap: var(--figma-space-8);
      border-bottom: 1px solid var(--figma-color-border);
    }

    .connected-libraries-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 16px 8px 16px 16px;
      gap: var(--figma-space-8);
      border-bottom: 1px solid var(--figma-color-border);
      box-sizing: border-box;
      min-height: 57px;
    }

    .settings-connected-libraries-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 16px 8px 16px 16px !important;
      gap: 8px;
      border-bottom: 1px solid var(--figma-color-border);
      box-sizing: border-box;
      min-height: 57px;
      width: 100%;
    }

    .library-selector-wrapper .settings-header {
      gap: 0;
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0 16px;
      border-bottom: 1px solid var(--figma-color-border);
      gap: var(--figma-space-8);
    }

    /* New Settings Styles */
    .settings-header-main {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      position: relative;
      height: 40px;
      box-sizing: border-box;
      border-bottom: 1px solid var(--figma-color-border);
      background: var(--figma-color-bg);
    }

    .header-title {
      font-weight: 600;
      font-size: 11px;
      color: var(--figma-color-text);
    }

    .settings-header-main .icon-btn {
      position: absolute;
      left: 8px; /* Back button on left */
    }

    .settings-content-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      flex: 1;
      overflow-y: auto;
    }

    /* Input Row Styles */
    .settings-input-group {
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 8px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .input-label {
      font-weight: 600;
      font-size: 11px;
      color: var(--figma-color-text);
    }

    /* Connected Libraries List */

    .connected-library-item {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      gap: 16px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .connected-library-item:first-child {
      border-top: none;
    }

    .library-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .library-name-text {
      font-weight: 600;
      font-size: 11px;
      color: var(--figma-color-text);
    }

    .library-stats {
      font-weight: 400;
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }

    /* Footer */
    .settings-footer {
      height: 40px;
      border-top: 1px solid var(--figma-color-border);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 4px 8px;
      background: var(--figma-color-bg);
    }

    .add-library-footer-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      color: var(--figma-color-text);
      font-size: 11px;
      font-weight: 500;
    }

    .add-library-footer-btn:hover {
      background: var(--figma-color-bg-hover);
      border-radius: 4px;
    }

    .context-menu-item:hover {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand) !important;
    }

    /* Generic icon button (reusable for any icon) */
    .icon-btn {
      background: none !important;
      border: none !important;
      cursor: pointer;
      padding: 0 !important;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 !important;
      outline: none;
      box-shadow: none !important;
      width: 24px;
      height: 24px;
      min-width: 24px;
      min-height: 24px;
      flex-shrink: 0;
      box-sizing: border-box;
      color: inherit !important;
    }

    .icon-btn svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .icon-btn svg path {
      fill: var(--figma-color-icon) !important;
    }

    .icon-btn:hover {
      background: var(--figma-color-bg-hover) !important;
    }

    .icon-btn:focus {
      outline: 2px solid var(--figma-color-border-brand) !important;
      outline-offset: -2px;
    }

    .settings-back-btn {
      background: none !important;
      border: none !important;
      cursor: pointer;
      padding: 0 !important;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 !important;
      outline: none;
      box-shadow: none !important;
      width: 24px;
      height: 24px;
      box-sizing: border-box;
    }

    .settings-back-btn:hover {
      background: var(--color-bghovertransparent, rgba(0, 0, 0, 0.05)) !important;
    }

    .settings-back-btn:active {
    }

    .settings-back-btn:focus {
      outline: 2px solid var(--color-border-selected, #0d99ff) !important;
    }

    .settings-row-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      padding: var(--figma-space-12) 0;
    }

    .settings-row-title {
      font-size: 11px;
      font-weight: 550;
      line-height: 16px;
      color: var(--figma-color-text);
      margin: 0;
    }

    .settings-row-description {
      font-size: 11px;
      font-weight: 450;
      line-height: 16px;
      color: var(--figma-color-text-secondary);
      margin: 0;
    }

    .settings-button {
      height: 24px;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border: none;
      border-radius: var(--figma-radius-6);
      font-size: var(--figma-font-size-11);
      font-weight: var(--figma-font-weight-medium);
      font-family: var(--figma-font-family);
      line-height: 16px;
      cursor: pointer;
      padding: 0 8px;
      white-space: nowrap;
      width: auto;
      flex-shrink: 0;
    }

    .settings-button:hover {
      background: var(--figma-color-bg-brand-hover);
    }
    
    .settings-section { 
      padding: var(--figma-space-12); 
      background: var(--figma-color-bg-secondary); 
      border-radius: var(--figma-radius-6); 
      border: 1px solid var(--figma-color-border); 
    }
    
    .library-name, .component-name { 
      font-weight: var(--figma-font-weight-semibold); 
      color: var(--figma-color-text); 
    }
    
    .library-count, .component-info { 
      font-size: var(--figma-font-size-11); 
      color: var(--figma-color-text-secondary); 
      margin-top: 2px; 
    }
    
    .hint { 
      margin-bottom: var(--figma-space-12); 
      font-size: var(--figma-font-size-11); 
      color: var(--figma-color-text-secondary); 
      padding: var(--figma-space-12); 
      background: var(--figma-color-bg-tertiary); 
      border-radius: var(--figma-radius-6); 
      border: 1px solid var(--figma-color-border);
    }
    
    .no-items { 
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center; 
      color: var(--figma-color-text-tertiary); 
      font-style: italic; 
      padding: var(--figma-space-24); 
      width: 100%;
      /* give it some vertical space so centering is visible when shown */
      min-height: 160px;
    }
    
    .view { display: none; }
    .view.active { 
      display: flex; 
      flex-direction: column;
      flex: 1;
      width: 100%;
      min-width: 0;
      overflow: hidden;
    }
    .result { margin-top: var(--figma-space-12); }
    
    /* Configuration styles */
    .config-tabs { 
      display: flex; 
      margin-bottom: var(--figma-space-16); 
      border-bottom: 1px solid var(--figma-color-border); 
      background: var(--figma-color-bg-secondary);
      border-radius: var(--figma-radius-6) var(--figma-radius-6) 0 0;
      overflow: hidden;
    }
    
    .config-tab-btn { 
      background: none; 
      border: none; 
      padding: var(--figma-space-12) var(--figma-space-16); 
      cursor: pointer; 
      border-bottom: 2px solid transparent;
      color: var(--figma-color-text-secondary);
      font-weight: var(--figma-font-weight-medium);
      
    }
    
    .config-tab-btn:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }
    
    .config-tab-btn.active { 
      border-bottom-color: var(--figma-color-border-brand); 
      font-weight: var(--figma-font-weight-semibold);
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
    }
    
    .config-section { display: none; }
    .config-section.active { display: block; }
    
    .library-config-item { 
      display: flex; 
      align-items: center; 
      gap: var(--figma-space-8); 
      margin-bottom: var(--figma-space-8); 
    }
    
    .library-config-item input { 
      flex: 1; 
      padding: var(--figma-space-8); 
      border: 1px solid var(--figma-color-border); 
      border-radius: var(--figma-radius-4);
      font-family: var(--figma-font-family);
      font-size: var(--figma-font-size-12);
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }
    
    .library-config-item input:focus {
      outline: none;
      border-color: var(--figma-color-border-brand);
      box-shadow: var(--figma-shadow-brand);
    }
    
    .library-config-item button { 
      width: auto; 
      padding: var(--figma-space-4) var(--figma-space-8); 
      margin: 0; 
      font-size: var(--figma-font-size-11);
      font-weight: var(--figma-font-weight-medium);
    }
    
    /* Modal styles - Figma UI3 */
    .modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.4);
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000;
      backdrop-filter: blur(4px);
    }
    
    .modal-content { 
      background: var(--figma-color-bg); 
      padding: var(--figma-space-24); 
      border-radius: var(--figma-radius-8); 
      width: 320px; 
      max-height: 480px; 
      overflow-y: auto;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--figma-color-border);
    }
    
    .modal-header { 
      font-weight: var(--figma-font-weight-semibold); 
      margin-bottom: var(--figma-space-16);
      font-size: var(--figma-font-size-16);
      color: var(--figma-color-text);
    }
    
    .target-library-item { 
      padding: var(--figma-space-12); 
      margin: var(--figma-space-4) 0; 
      border: 1px solid var(--figma-color-border); 
      border-radius: var(--figma-radius-6); 
      cursor: pointer;
      
      background: var(--figma-color-bg);
    }
    
    .target-library-item:hover { 
      border-color: var(--figma-color-border-brand); 
      background: var(--figma-color-bg-secondary);
      box-shadow: var(--figma-shadow-sm);
    }
    
    .target-library-item.selected { 
      border-color: var(--figma-color-border-brand); 
      background: var(--figma-color-bg-selected);
      box-shadow: var(--figma-shadow-brand);
    }
    
    .target-library-item.disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    
    .target-library-item.disabled:hover { 
      border-color: var(--figma-color-border); 
      background: var(--figma-color-bg-tertiary); 
      box-shadow: none;
    }
    
    .target-library-name { 
      font-weight: var(--figma-font-weight-medium);
      color: var(--figma-color-text);
    }
    
    .modal-buttons { 
      display: flex; 
      gap: var(--figma-space-8); 
      margin-top: var(--figma-space-20); 
    }
    
    .modal-buttons button { 
      flex: 1; 
      padding: var(--figma-space-8) var(--figma-space-16);
    }
    
    /* Secondary button variant */
    .modal-buttons button.secondary {
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border-strong);
    }
    
    .modal-buttons button.secondary:hover {
      background: var(--figma-color-bg-hover);
      border-color: var(--figma-color-border-brand);
    }
    
    /* Button Variants - Figma UI3 */
    .primary-button {
      background: var(--figma-color-bg-success) !important;
      color: var(--figma-color-text-onbrand) !important;
    }
    
    .primary-button:hover {
      background: var(--figma-color-bg-success-hover) !important;
    }
    
    .secondary-button {
      background: var(--figma-color-bg) !important;
      color: var(--figma-color-text) !important;
      border: 1px solid var(--figma-color-border-strong) !important;
    }
    
    .secondary-button:hover {
      background: var(--figma-color-bg-hover) !important;
      border-color: var(--figma-color-border-brand) !important;
    }
    
    .tertiary-button {
      background: var(--figma-color-bg-tertiary) !important;
      color: var(--figma-color-text-secondary) !important;
      border: 1px solid var(--figma-color-border) !important;
    }
    
    .tertiary-button:hover {
      background: var(--figma-color-bg-hover) !important;
      color: var(--figma-color-text) !important;
      border-color: var(--figma-color-border-strong) !important;
    }
    
    /* Enhanced visual hierarchy */
    .icon-button {
      display: inline-flex;
      align-items: center;
      gap: var(--figma-space-8);
    }
    
    /* Figma UI3 specific improvements */
    .plugin-container {
      background: var(--figma-color-bg);
      border-radius: var(--figma-radius-8);
      overflow: hidden;
    }
    
    /* Enhanced focus states for accessibility */
    *:focus-visible {
      outline: 2px solid var(--figma-color-border-brand);
      outline-offset: 2px;
    }
    
    /* Improved text contrast */
    .component-info.secondary {
      color: var(--figma-color-text-tertiary);
    }
    
    /* No global transitions - theme switching should be instant */
    
    /* New Scan Results View Styles */
    .search-container {
      display: flex;
      align-items: flex-start;
      gap: var(--figma-space-8);
      padding: 16px var(--figma-space-16);
      border-bottom: 1px solid var(--figma-color-border);
    }
    
    .search-input-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-bg-secondary);
      border-radius: var(--figma-radius-6);
      padding: 0;
      height: 22px;
      margin-top: 0;
    }

    .search-input-wrapper:focus-within {
      border-color: var(--figma-color-border-selected);
    }
    
    .search-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--figma-color-icon-secondary);
      flex-shrink: 0;
    }

    .search-input-wrapper:focus-within .search-icon {
      color: var(--figma-color-icon);
    }
    
    .search-icon svg {
      width: 24px;
      height: 24px;
    }
    
    .search-input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 11px;
      font-weight: 450;
      line-height: 16px;
      color: var(--figma-color-text);
      font-family: var(--figma-font-family);
      padding: 0;
      margin: 0;
    }
    
    .search-input::placeholder {
      color: var(--figma-color-text-secondary);
    }
    
    .filter-button {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--figma-color-icon);
      background: none;
      border: none;
      outline: none;
      padding: 0;
      cursor: pointer;
      flex-shrink: 0;
      border-radius: var(--figma-radius-4);
      transition: background 0.075s ease, color 0.075s ease;
      box-shadow: none;
      margin: 0;
    }
    
    .filter-button:hover {
      background: var(--figma-color-bg-secondary);
      box-shadow: none;
      outline: none;
      color: var(--figma-color-icon);
    }
    
    .filter-button:focus {
      outline: 1px solid var(--figma-color-border-selected);
      outline-offset: 2px;
    }
    
    .filter-button:active {
      transform: none;
      outline: none;
    }
    
    .filter-button.active {
      background: var(--figma-color-bg-selected);
      color: var(--figma-color-icon-brand);
      outline: none;
      box-shadow: none;
    }
    
    /* Filter Dropdown Blocking Overlay */
    .filter-dropdown-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1500; /* Increased to be above everything else but below menus */
      display: none;
      /* background: rgba(0,255,0,0.1);  Debug tint */
    }
    
    /* Ensure menus are above the overlay */
    .filter-dropdown, 
    #scanResultContextMenu, 
    #componentSelectionMenu, 
    .dropdown-menu {
        z-index: 2000;
    }
    
    .filter-dropdown-overlay.active {
      display: block;
    }
    
    /* Filter Dropdown Menu Styles */
    .filter-dropdown {
      position: absolute;
      top: 104px;
      right: 16px;
      z-index: 3000;
      background: #1e1e1e;
      border-radius: 13px;
      box-shadow: 0px 0px 0.5px 0px rgba(0,0,0,0.12), 0px 10px 16px 0px rgba(0,0,0,0.12), 0px 2px 5px 0px rgba(0,0,0,0.15);
      overflow: hidden;
      min-width: 208px;
      padding: 8px;
    }
    
    .filter-menu {
      display: flex;
      flex-direction: column;
    }
    
    .filter-menu-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 24px;
      padding: 0 8px;
      border-radius: 5px;
      color: var(--figma-color-text);
      background: transparent;
      border: none;
      cursor: pointer;
      font-family: var(--figma-font-family);
      font-size: var(--figma-font-size-11);
      font-weight: 450;
      line-height: 16px;
    }
    
    .filter-menu-item:hover {
      background: var(--figma-color-bg-brand);
    }
    
    .filter-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      height: 24px;
      cursor: pointer;
      padding: 0;
      color: var(--figma-color-text);
      font-family: var(--figma-font-family);
      font-size: var(--figma-font-size-11);
      font-weight: 450;
      line-height: 16px;
      user-select: none;
      gap: 12px;
    }
    
    .filter-label-text {
      flex: 1;
      color: var(--figma-color-text-onbrand);
    }
    
    .library-mapping-header {
      display: flex;
      align-items: center;
      gap: var(--figma-space-20);
      margin-bottom: var(--figma-space-16);
      padding: 0 var(--figma-space-16);
    }
    
    .header-row-content {
      flex: 1;
      display: flex;
      align-items: center;
      min-height: 1px;
      min-width: 1px;
    }
    
    .header-source-label,
    .header-target-label {
      flex-basis: 0;
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      min-height: 1px;
      min-width: 1px;
      flex-shrink: 0;
    }
    
    .library-name {
      font-size: var(--figma-font-size-11);
      font-weight: 450;
      color: var(--figma-color-text-secondary);
      font-family: var(--figma-font-family);
      line-height: 16px;
      letter-spacing: 0.055px;
      flex-shrink: 0;
    }
    
    .header-spacer {
      width: 16px;
      height: 24px;
      flex-shrink: 0;
    }
    
    .header-arrow-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      overflow: hidden;
    }
    
    .arrow-icon {
      color: var(--figma-color-icon-tertiary);
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }
    
    .scan-heading-row {
      display: flex;
      gap: var(--figma-space-20);
      align-items: center;
      width: 100%;
      padding-left: var(--figma-space-16);
      padding-right: var(--figma-space-16);
      margin-top: 16px;
      margin-bottom: var(--figma-space-4);
      box-sizing: border-box;
    }

    .scan-heading-row .row-content {
      display: flex;
      flex: 1;
      flex-basis: 0;
      align-items: center;
      gap: 76px;
      min-height: 1px;
    }

    .header-label {
      display: flex;
      flex: 1;
      flex-basis: 0;
      gap: var(--figma-space-8);
      align-items: center;
      justify-content: flex-start;
      min-height: 1px;
      box-sizing: border-box;
    }

    /* Removed .scan-heading-row .row-content .header-label:first-child padding-right override */

    .header-label-text {
      font-family: 'Inter', sans-serif;
      font-weight: 450;
      font-size: 11px;
      line-height: 16px;
      color: var(--figma-color-text-secondary);
      width: auto;
      flex-shrink: 0;
    }

    /* Target Library Dropdown */
    .target-library-dropdown {
      position: relative;
      display: flex;
      align-items: center;
      height: 24px;
      width: 100%;
      box-sizing: border-box;
      z-index: 2001; /* Must be higher than overlay (1500) */
    }

    .dropdown-trigger {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 0 0 0 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 5px;
      cursor: pointer;
      height: 24px;
      width: 100%;
      color: var(--figma-color-text);
      font-size: 11px;
      font-weight: 500;
      transition: all 0.075s ease;
      background-color: var(--figma-color-bg);
      box-sizing: border-box;
      user-select: none;
    }

    .dropdown-trigger:hover {
      background-color: var(--figma-color-bg-hover);
    }
    
    .dropdown-trigger.active {
        border-color: var(--figma-color-border-selected);
        background-color: var(--figma-color-bg);
    }

    .component-dropdown-trigger {
      border-color: transparent;
      background-color: transparent;
      width: fit-content;
      max-width: 100%;
    }

    .component-dropdown-trigger.active {
      border-color: transparent;
    }

    .selected-library-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .chevron-icon {
      width: 24px;
      height: 24px;
      min-width: 24px;
      min-height: 24px;
      color: var(--figma-color-icon);
      flex-shrink: 0;
      display: block;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: #1e1e1e;
      border-radius: 13px;
      box-shadow: 0px 0px 0.5px 0px rgba(0,0,0,0.12), 0px 10px 16px 0px rgba(0,0,0,0.12), 0px 2px 5px 0px rgba(0,0,0,0.15);
      width: 254px;
      z-index: 2000;
      display: none;
      max-height: 200px;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 4px;
      box-sizing: border-box;
    }

    .dropdown-menu.show {
      display: block !important;
    }

    /* Property Mapping Menu Specific Styles */
    #propMappingDropdownMenu {
        background-color: #1e1e1e;
        border-radius: 13px;
        box-shadow: 0px 0px 0.5px 0px rgba(0,0,0,0.12), 0px 10px 16px 0px rgba(0,0,0,0.12), 0px 2px 5px 0px rgba(0,0,0,0.15);
        padding: 8px 0;
        min-width: 240px;
        max-width: 320px;
        color: white;
        font-family: 'Inter', sans-serif;
        box-sizing: border-box;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .pm-menu-header {
        display: flex;
        align-items: center;
        padding: 0 4px 0 8px;
        height: 24px;
        margin: 0 8px; /* Container padding */
    }

    .pm-menu-title {
        flex: 1;
        font-size: 11px;
        font-weight: 450;
        color: white;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .pm-menu-badge {
        background-color: #2c2c2c;
        border-radius: 5px;
        height: 16px;
        display: flex;
        align-items: center;
        padding: 0 4px 0 0;
        gap: 4px;
    }
    
    .pm-menu-badge-text {
        font-size: 11px;
        font-weight: 450;
        color: white;
    }

    .pm-menu-divider {
        height: 16px; /* Mockup had 24px, but visually 16px might be tighter */
        width: 100%;
        position: relative;
    }
    
    .pm-menu-divider-line {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background-color: #383838;
    }

    .pm-menu-section-header {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding: 4px 16px; 
        font-size: 11px;
        color: rgba(255,255,255,0.4);
        text-transform: none;
        font-weight: 450;
    }

    .pm-menu-item {
        display: flex;
        align-items: center;
        padding: 0 8px 0 20px;
        height: 24px;
        cursor: pointer;
        position: relative;
        border-radius: 5px;
        margin: 0 8px;
        color: white;
        transition: background-color 0.1s;
    }

    .pm-menu-item:hover {
        background-color: rgba(255,255,255,0.1);
    }
    
    .pm-menu-item-check {
        position: absolute;
        left: 4px;
        top: 4px;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    .pm-menu-item-text {
        font-size: 11px;
        font-weight: 450;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }
    
    .pm-menu-item-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0px; 
        color: white;
    }

    .dropdown-option {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 4px;
      height: 24px;
      padding: 0 8px 0 4px;
      border-radius: 5px;
      color: var(--figma-color-text);
      background: transparent;
      border: none;
      cursor: pointer;
      font-family: var(--figma-font-family);
      font-size: var(--figma-font-size-11);
      font-weight: 450;
      line-height: 16px;
    }

    .dropdown-check-icon {
      width: 16px;
      height: 16px;
      opacity: 0;
      flex-shrink: 0;
      color: var(--figma-color-text);
    }

    .dropdown-option.selected .dropdown-check-icon {
      opacity: 1;
    }

    .dropdown-option:hover {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }
    
    .dropdown-option:hover span {
      color: var(--figma-color-text-onbrand);
    }

    .dropdown-divider {
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: calc(100% + 16px);
      margin-left: -8px;
      margin-right: -8px;
    }
    
    .dropdown-divider::after {
      content: '';
      height: 1px;
      width: 100%;
      background-color: #383838;
    }
    
    .menu-checkbox-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 16px; 
        width: 16px;
    }
    
    .menu-checkbox {
      width: 16px;
      height: 16px;
      border: 1px solid #444; 
      border-radius: 5px;
      background: #383838;
      box-sizing: border-box;
      position: relative;
    }
    
    .filter-menu-item.checked .menu-checkbox {
         background: var(--figma-color-bg-brand);
         border-color: var(--figma-color-border);
    }
    
    .filter-menu-item.checked .menu-checkbox::after {
        content: '';
        position: absolute;
        width: 8px;
        height: 7px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-image: url("data:image/svg+xml,%3Csvg width='8' height='7' viewBox='0 0 8 7' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 3.5L3 5.5L7 1.5' stroke='white' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
    }

    /* Add Library Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-container {
      width: 320px;
      background: var(--figma-color-bg);
      border-radius: 13px;
      box-shadow: 0px 0px 0.5px 0px rgba(0,0,0,0.08), 0px 10px 24px 0px rgba(0,0,0,0.18), 0px 2px 5px 0px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
      border-bottom: 1px solid var(--figma-color-border);
      background: var(--figma-color-bg);
    }

    .modal-title {
      font-weight: 550;
      font-size: 11px;
      color: var(--figma-color-text);
      margin-left: 8px;
    }

    .modal-close-btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--figma-color-icon);
      padding: 0;
    }

    .modal-close-btn:hover {
      background: var(--figma-color-bg-hover);
      border-radius: var(--figma-radius-4);
    }

    .modal-body {
      padding: 0 16px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-label {
      font-weight: 550;
      font-size: 11px;
      color: var(--figma-color-text);
      margin-bottom: 8px;
    }

    .modal-input {
      width: 100%;
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      border: 1px solid transparent;
      border-radius: 5px;
      font-family: var(--figma-font-family);
      font-size: 11px;
      color: var(--figma-color-text);
      box-sizing: border-box;
      outline: none;
    }
    
    .modal-input:focus {
        border-color: var(--figma-color-border-selected);
    }

    .input-helper-text {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin-top: 8px;
    }

    .modal-footer {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 8px;
      border-top: 1px solid var(--figma-color-border);
      background: var(--figma-color-bg);
    }

    .modal-connect-btn {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border: none;
      border-radius: 6px;
      padding: 0 8px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      height: 24px;
      display: flex;
      align-items: center;
      width: auto;
    }

    .modal-connect-btn:hover {
      background: var(--figma-color-bg-brand-hover);
    }

    .header-spacer {
      width: 28px;
      height: 24px;
      flex-shrink: 0;
    }

    .header-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Property Mapping View Styles */
    .prop-mapping-row {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      align-items: center;
      width: 100%;
      border-bottom: 1px solid var(--figma-color-border);
      box-sizing: border-box;
    }

    .prop-source-col {
       display: flex;
       flex: 1;
       gap: 4px;
       align-items: center;
       min-width: 0;
    }

    .prop-target-col {
       display: flex;
       flex: 1;
       align-items: center;
       min-width: 0;
    }

    .prop-label {
        font-family: 'Inter', sans-serif;
        font-weight: 550; /* Semi-bold */
        font-size: 11px;
        color: var(--figma-color-text);
        white-space: nowrap;
    }
    
    .prop-icon {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 5px;
    }
    
    .prop-dropdown {
        background-color: var(--figma-color-bg);
        border: 1px solid var(--figma-color-border);
        border-radius: 5px;
        height: 24px;
        flex: 1;
        display: flex;
        align-items: center;
        padding-left: 8px;
        padding-right: 0;
        overflow: hidden;
        cursor: pointer;
        position: relative;
        color: var(--figma-color-text);
        font-size: 11px;
        font-weight: 500;
        transition: all 0.075s ease;
        box-sizing: border-box;
        user-select: none;
    }

    .prop-dropdown:hover {
        background: var(--figma-color-bg-hover);
    }
    
    .prop-dropdown.active {
        background: var(--figma-color-bg-pressed, var(--figma-color-bg-secondary)); 
        border-color: var(--figma-color-border-brand, #0D99FF);
    }
    
    .prop-dropdown-label-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        overflow: hidden;
    }
    
    .prop-dropdown-label {
        font-weight: inherit;
        font-size: 11px;
        color: inherit;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        max-width: 100%;
        line-height: 16px;
    }
    
    .mapping-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: var(--figma-space-12) var(--figma-space-16);
      border-bottom: 1px solid var(--figma-color-border);
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }
    
    .mapping-item:hover:not(:has(.library-more-btn:hover, .component-dropdown-trigger:hover)) {
      background: var(--figma-color-bg-hover);
    }
    
    .mapping-checkbox {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 5px;
      margin: 0;
      padding: 0;
      flex-shrink: 0;
      vertical-align: middle;
      border: 1px solid var(--figma-color-border);
      background-color: var(--figma-color-bg-secondary);
      cursor: pointer;
      position: relative;
    }
    
    .mapping-checkbox:checked {
      background-color: var(--figma-color-bg-brand);
      border-color: var(--figma-color-border);
    }
    
    .mapping-checkbox:checked::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 7px;
      background-image: url("data:image/svg+xml,%3Csvg width='8' height='7' viewBox='0 0 8 7' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 3.5L3 5.5L7 1.5' stroke='white' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
    }
    
    .mapping-item .row-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }
    
    .source-element,
    .target-element {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }
    
    .icon-container {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-sizing: border-box;
    }
    
    .component-details {
      display: flex;
      flex-direction: column;
      gap: var(--figma-space-2);
      flex: 1;
    }
    
    .component-library {
      font-size: var(--figma-font-size-11);
      color: var(--figma-color-text-secondary);
    }
    

    
    .component-icon-container {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    
    .component-icon {
      flex-shrink: 0;
      color: var(--figma-color-icon-secondary);
      Height: 100%
    }
    
    .text-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--figma-font-size-11);
      font-weight: var(--figma-font-weight-semibold);
      color: var(--figma-color-icon-secondary);
      flex-shrink: 0;
      margin: 0;
      padding: 0;
    }
    
    .swatch-container {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin: 0;
      padding: 0;
    }
    
    .color-swatch {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    
    .component-name {
      font-size: 11px !important;
      font-weight: 550;
      color: var(--figma-color-text);
      font-family: var(--figma-font-family);
      line-height: 16px;
      margin: 0;
      padding: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }
    
    .arrow-icon {
      color: var(--figma-color-icon-tertiary);
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }
    
    .swap-button-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--figma-color-bg);
      border-top: 1px solid var(--figma-color-border);
      padding: 4px 8px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      z-index: 100;
      height: 32px;
    }
    
    .swap-library-btn {
      height: 24px;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border: none;
      border-radius: var(--figma-radius-6);
      font-size: var(--figma-font-size-11);
      font-weight: var(--figma-font-weight-medium);
      font-family: var(--figma-font-family);
      line-height: 16px;
      cursor: pointer;
      padding: 0 8px;
      white-space: nowrap;
      width: auto;
    }
    
    .swap-library-btn:hover {
      background: var(--figma-color-bg-brand-hover);
    }

    .secondary-btn {
      height: 24px;
      background: transparent;
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
      border-radius: var(--figma-radius-6);
      font-size: var(--figma-font-size-11);
      font-weight: var(--figma-font-weight-medium);
      font-family: var(--figma-font-family);
      line-height: 16px;
      cursor: pointer;
      padding: 0 8px;
      white-space: nowrap;
      width: auto;
      margin-right: 8px;
    }
    
    .secondary-btn:hover {
      background: var(--figma-color-bg-hover);
    }
    
    /* Figma-style dividers */
    .divider {
      height: 1px;
      background: var(--figma-color-border);
      margin: var(--figma-space-16) 0;
    }
    
    /* Status indicators */
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
      margin-right: var(--figma-space-8);
    }
    
    .status-dot.success { background: var(--figma-color-bg-success); }
    .status-dot.warning { background: #f59e0b; }
    .status-dot.info { background: var(--figma-color-bg-brand); }
    
    /* Centered Scan View Styles */
    .scan-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      padding: var(--figma-space-24);
    }
    
    .scan-content {
      text-align: center;
      max-width: 300px;
    }
    
    .scan-title {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-weight: 550;
      font-size: 13px;
      line-height: 22px;
      letter-spacing: -0.25%;
      text-align: center;
      color: var(--figma-color-text);
      margin: 0 0 8px 0;
      display: block !important;
    }
    
    .scan-description {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-weight: 400;
      font-size: 11px;
      line-height: 16px;
      color: var(--figma-color-text-secondary);
      margin: 0 0 30px 0;
      text-align: center;
    }
    
    .scan-button {
      background: hsla(205, 100%, 53%, 1);
      color: white;
      border: none;
      border-radius: var(--figma-radius-6);
      height: 32px;
      padding: 0 var(--figma-space-16);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-size: var(--figma-font-size-11);
      line-height: 16px;
      font-weight: 400;
      cursor: pointer;
      
      box-shadow: var(--figma-shadow-sm);
      width: auto;
      margin: 0;
    }
    
    .scan-button:hover {
      background: hsla(205, 100%, 48%, 1);
      box-shadow: var(--figma-shadow-md);
    }
    
    .scan-button:active {
      background: hsla(205, 100%, 43%, 1);
      transform: translateY(1px);
    }
    
    .scan-button:focus {
      outline: none;
      box-shadow: var(--figma-shadow-brand);
    }
    
    .settings-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      border-top: 1px solid var(--figma-color-border);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-left: 12px;
      padding-right: 12px;
      background: var(--figma-color-bg);
    }
    
    .settings-icon-btn {
      background: none !important;
      border: none !important;
      cursor: pointer;
      padding: 0 !important;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 !important;
      outline: none;
      box-shadow: none !important;
    }

    .settings-icon-btn:hover {
      background: var(--color-bghovertransparent, rgba(0, 0, 0, 0.05)) !important;
    }

    .settings-icon-btn:focus {
      outline: 2px solid var(--color-border-selected, #0d99ff) !important;
      outline-offset: 0;
    }
    
    .settings-icon-btn svg {
      width: 16.89px;
      height: 18px;
    }
    
    .settings-icon-btn:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-icon-secondary);
      box-shadow: none;
    }

    /* Library Selector View Styles */
    .library-selector-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }
    
    .library-selector-heading {
      padding: 24px var(--figma-space-16) 4px var(--figma-space-16);
      flex-shrink: 0;
    }
    
    .library-selector-title {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-weight: 550;
      font-size: 13px;
      line-height: 22px;
      letter-spacing: -0.325%;
      color: var(--figma-color-text);
      margin: 0;
      display: block;
    }
    
    .library-selector-content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }
    
    .library-list {
      display: flex;
      flex-direction: column;
    }
    
    .library-selector-item {
      display: flex;
      align-items: center;
      padding: var(--figma-space-8) var(--figma-space-16) var(--figma-space-8) var(--figma-space-16);
      cursor: pointer;
      transition: background-color 0.2s ease;
      position: relative;
      border: none;
      background: var(--figma-color-bg);
    }

    .library-selector-item:first-child {
      padding-top: var(--figma-space-8);
    }
    
    .library-selector-item:hover {
      background: var(--figma-color-bg-hover);
    }
    
    .library-selector-item::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--figma-color-border);
    }
    
    .library-selector-thumbnail {
      width: 90px;
      height: 59px;
      margin-right: var(--figma-space-12);
      background: #a7a7a7;
      border-radius: 7px;
      flex-shrink: 0;
    }
    
    .library-selector-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .library-selector-name {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-weight: 550;
      font-size: 11px;
      line-height: 16px;
      color: var(--figma-color-text);
      margin: 0;
      white-space: nowrap;
    }
    
    .library-selector-count {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-weight: 450;
      font-size: 11px;
      line-height: 16px;
      color: var(--figma-color-text-secondary);
      margin: 0;
    }
    
    .library-selector-arrow {
      width: 24px;
      height: 24px;
      color: var(--figma-color-icon);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: var(--figma-space-12);
    }
    
    /* New scan results styles */
    .close-btn {
      background: none;
      border: none;
      color: var(--figma-color-icon-tertiary);
      cursor: pointer;
      padding: var(--figma-space-4);
      border-radius: var(--figma-radius-4);
      font-size: var(--figma-font-size-14);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      
    }
    
    .close-btn:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-icon);
    }
    
    .scan-results-content {
      flex: 1;
      overflow-y: auto;
      padding-bottom: var(--figma-space-16);
    }

    .component-mappings {
      display: flex;
      flex-direction: column;
      width: 100%;
      min-width: 0;
      overflow-y: auto;
      flex: 1;
    }
    
    .component-icon {
      color: var(--figma-color-icon-tertiary);
      font-size: var(--figma-font-size-14);
      font-family: monospace;
    }
    
    .component-name {
      font-size: var(--figma-font-size-14);
      color: var(--figma-color-text);
      font-weight: var(--figma-font-weight-normal);
    }
  </style>
</head>
<body>
  <!-- Scan View -->
  <div id="scanView" class="view active">
    <div class="scan-container">
      <div class="scan-content">
        <h1 class="scan-title">Select a frame to scan</h1>
        <p class="scan-description">Select a frame in your design to automatically scan for components and tokens</p>
        <button id="scanAllBtn" class="scan-button" style="display: none;">Scan frame</button>
      </div>
    </div>
    <div class="settings-footer">
      <button id="settingsBtn" class="icon-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M17.2874 6.04442C16.7257 6.28419 16.0664 6.26482 15.5 5.9378C14.9335 5.61073 14.587 5.04928 14.5139 4.44284C14.4446 3.8674 14.0187 3.19018 13.2168 3.08168C12.8184 3.02778 12.4122 3 12 3C11.5878 3 11.1816 3.02778 10.7832 3.08168C9.98124 3.19018 9.55542 3.8674 9.48605 4.44285C9.41295 5.04929 9.06649 5.61075 8.49998 5.93782C7.93356 6.26485 7.27423 6.28421 6.71254 6.04443C6.18009 5.81713 5.38248 5.84708 4.88726 6.48493C4.39057 7.12468 3.978 7.83369 3.66653 8.59536C3.36037 9.34404 3.73424 10.0507 4.19772 10.3981C4.6867 10.7646 4.99995 11.3456 4.99995 12C4.99995 12.6544 4.6867 13.2354 4.19773 13.6019C3.73425 13.9493 3.36039 14.656 3.66654 15.4047C3.97801 16.1663 4.39058 16.8753 4.88726 17.5151C5.38247 18.1529 6.18008 18.1829 6.71254 17.9556C7.27422 17.7158 7.93355 17.7352 8.49996 18.0622C9.06647 18.3893 9.41293 18.9507 9.48603 19.5571C9.5554 20.1326 9.98122 20.8098 10.7831 20.9183C11.1815 20.9722 11.5878 21 12 21C12.4122 21 12.8184 20.9722 13.2168 20.9183C14.0187 20.8098 14.4445 20.1326 14.5139 19.5572C14.587 18.9507 14.9335 18.3893 15.5 18.0622C16.0664 17.7352 16.7257 17.7158 17.2874 17.9556C17.8199 18.1829 18.6175 18.1529 19.1127 17.5151C19.6094 16.8753 20.0219 16.1663 20.3334 15.4047C20.6396 14.656 20.2657 13.9493 19.8022 13.6019C19.3132 13.2354 19 12.6544 19 12C19 11.3456 19.3132 10.7646 19.8022 10.3981C20.2657 10.0507 20.6396 9.34401 20.3334 8.59534C20.0219 7.83367 19.6094 7.12466 19.1127 6.48492C18.6175 5.84707 17.8199 5.81712 17.2874 6.04442ZM15 6.80383C15.8505 7.29484 16.8414 7.32212 17.68 6.96412C17.9042 6.86842 18.1733 6.90563 18.3228 7.09817C18.7645 7.66714 19.1312 8.29732 19.4078 8.97384C19.5002 9.19967 19.3977 9.4516 19.2025 9.59792C18.4724 10.1451 18 11.0174 18 12C18 12.9826 18.4724 13.8549 19.2025 14.4021C19.3977 14.5484 19.5002 14.8003 19.4078 15.0262C19.1312 15.7027 18.7645 16.3329 18.3228 16.9018C18.1733 17.0944 17.9042 17.1316 17.68 17.0359C16.8414 16.6779 15.8504 16.7051 15 17.1962C14.1494 17.6873 13.6302 18.532 13.5211 19.4375C13.4919 19.6799 13.3246 19.8946 13.0827 19.9274C12.7286 19.9753 12.3672 20 12 20C11.6328 20 11.2713 19.9753 10.9172 19.9273C10.6753 19.8946 10.5081 19.6799 10.4788 19.4375C10.3697 18.532 9.85057 17.6873 8.99996 17.1962C8.14949 16.7051 7.15855 16.6779 6.31992 17.0359C6.09573 17.1316 5.82663 17.0944 5.67715 16.9018C5.23542 16.3329 4.86879 15.7027 4.59214 15.0262C4.49979 14.8003 4.60226 14.5484 4.79748 14.4021C5.52756 13.8549 5.99995 12.9826 5.99995 12C5.99995 11.0174 5.52755 10.1452 4.79747 9.59795C4.60225 9.45162 4.49978 9.19969 4.59213 8.97387C4.86878 8.29734 5.23541 7.66715 5.67715 7.09818C5.82663 6.90564 6.09574 6.86843 6.31992 6.96413C7.15855 7.32214 8.14951 7.29487 8.99998 6.80385C9.85059 6.31274 10.3697 5.46798 10.4789 4.56252C10.5081 4.32013 10.6753 4.10538 10.9172 4.07265C11.2713 4.02474 11.6328 4 12 4C12.3672 4 12.7286 4.02474 13.0827 4.07265C13.3247 4.10539 13.4919 4.32013 13.5211 4.56252C13.6303 5.46797 14.1494 6.31273 15 6.80383ZM9.49996 12C9.49996 10.6193 10.6192 9.5 12 9.5C13.3807 9.5 14.5 10.6193 14.5 12C14.5 13.3807 13.3807 14.5 12 14.5C10.6192 14.5 9.49996 13.3807 9.49996 12ZM12 8.5C10.067 8.5 8.49996 10.067 8.49996 12C8.49996 13.933 10.067 15.5 12 15.5C13.933 15.5 15.5 13.933 15.5 12C15.5 10.067 13.933 8.5 12 8.5Z" fill="var(--figma-color-icon)" fill-opacity="0.9"/>
        </svg>
      </button>
    </div>
    <div id="scanResult" class="result"></div>
  </div>
  
  <script>
    // Global variable to store the last scan data
    window.lastScanData = null;
  </script>

  <!-- Connect Library View - REMOVED -->
  <!--
  <div id="connectLibraryView" class="view">
    <div class="scan-container">
      <div class="scan-content">
        <h1 class="scan-title">Connect library to scan frame</h1>
        <p class="scan-description">Connect a library to get details from the scan</p>
        <button id="connectLibraryActionBtn" class="scan-button">Connect library</button>
      </div>
    </div>
    <div class="settings-footer">
      <button id="settingsBtnFromConnect" class="settings-icon-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M17.2874 6.04442C16.7257 6.28419 16.0664 6.26482 15.5 5.9378C14.9335 5.61073 14.587 5.04928 14.5139 4.44284C14.4446 3.8674 14.0187 3.19018 13.2168 3.08168C12.8184 3.02778 12.4122 3 12 3C11.5878 3 11.1816 3.02778 10.7832 3.08168C9.98124 3.19018 9.55542 3.8674 9.48605 4.44285C9.41295 5.04929 9.06649 5.61075 8.49998 5.93782C7.93356 6.26485 7.27423 6.28421 6.71254 6.04443C6.18009 5.81713 5.38248 5.84708 4.88726 6.48493C4.39057 7.12468 3.978 7.83369 3.66653 8.59536C3.36037 9.34404 3.73424 10.0507 4.19772 10.3981C4.6867 10.7646 4.99995 11.3456 4.99995 12C4.99995 12.6544 4.6867 13.2354 4.19773 13.6019C3.73425 13.9493 3.36039 14.656 3.66654 15.4047C3.97801 16.1663 4.39058 16.8753 4.88726 17.5151C5.38247 18.1529 6.18008 18.1829 6.71254 17.9556C7.27422 17.7158 7.93355 17.7352 8.49996 18.0622C9.06647 18.3893 9.41293 18.9507 9.48603 19.5571C9.5554 20.1326 9.98122 20.8098 10.7831 20.9183C11.1815 20.9722 11.5878 21 12 21C12.4122 21 12.8184 20.9722 13.2168 20.9183C14.0187 20.8098 14.4445 20.1326 14.5139 19.5572C14.587 18.9507 14.9335 18.3893 15.5 18.0622C16.0664 17.7352 16.7257 17.7158 17.2874 17.9556C17.8199 18.1829 18.6175 18.1529 19.1127 17.5151C19.6094 16.8753 20.0219 16.1663 20.3334 15.4047C20.6396 14.656 20.2657 13.9493 19.8022 13.6019C19.3132 13.2354 19 12.6544 19 12C19 11.3456 19.3132 10.7646 19.8022 10.3981C20.2657 10.0507 20.6396 9.34401 20.3334 8.59534C20.0219 7.83367 19.6094 7.12466 19.1127 6.48492C18.6175 5.84707 17.8199 5.81712 17.2874 6.04442ZM15 6.80383C15.8505 7.29484 16.8414 7.32212 17.68 6.96412C17.9042 6.86842 18.1733 6.90563 18.3228 7.09817C18.7645 7.66714 19.1312 8.29732 19.4078 8.97384C19.5002 9.19967 19.3977 9.4516 19.2025 9.59792C18.4724 10.1451 18 11.0174 18 12C18 12.9826 18.4724 13.8549 19.2025 14.4021C19.3977 14.5484 19.5002 14.8003 19.4078 15.0262C19.1312 15.7027 18.7645 16.3329 18.3228 16.9018C18.1733 17.0944 17.9042 17.1316 17.68 17.0359C16.8414 16.6779 15.8504 16.7051 15 17.1962C14.1494 17.6873 13.6302 18.532 13.5211 19.4375C13.4919 19.6799 13.3246 19.8946 13.0827 19.9274C12.7286 19.9753 12.3672 20 12 20C11.6328 20 11.2713 19.9753 10.9172 19.9273C10.6753 19.8946 10.5081 19.6799 10.4788 19.4375C10.3697 18.532 9.85057 17.6873 8.99996 17.1962C8.14949 16.7051 7.15855 16.6779 6.31992 17.0359C6.09573 17.1316 5.82663 17.0944 5.67715 16.9018C5.23542 16.3329 4.86879 15.7027 4.59214 15.0262C4.49979 14.8003 4.60226 14.5484 4.79748 14.4021C5.52756 13.8549 5.99995 12.9826 5.99995 12C5.99995 11.0174 5.52755 10.1452 4.79747 9.59795C4.60225 9.45162 4.49978 9.19969 4.59213 8.97387C4.86878 8.29734 5.23541 7.66715 5.67715 7.09818C5.82663 6.90564 6.09574 6.86843 6.31992 6.96413C7.15855 7.32214 8.14951 7.29487 8.99998 6.80385C9.85059 6.31274 10.3697 5.46798 10.4789 4.56252C10.5081 4.32013 10.6753 4.10538 10.9172 4.07265C11.2713 4.02474 11.6328 4 12 4C12.3672 4 12.7286 4.02474 13.0827 4.07265C13.3247 4.10539 13.4919 4.32013 13.5211 4.56252C13.6303 5.46797 14.1494 6.31273 15 6.80383ZM9.49996 12C9.49996 10.6193 10.6192 9.5 12 9.5C13.3807 9.5 14.5 10.6193 14.5 12C14.5 13.3807 13.3807 14.5 12 14.5C10.6192 14.5 9.49996 13.3807 9.49996 12ZM12 8.5C10.067 8.5 8.49996 10.067 8.49996 12C8.49996 13.933 10.067 15.5 12 15.5C13.933 15.5 15.5 13.933 15.5 12C15.5 10.067 13.933 8.5 12 8.5Z" fill="var(--figma-color-icon)" fill-opacity="0.9"/>
        </svg>
      </button>
    </div>
  </div>
  -->

  <!-- Library Selection View -->
  <div id="librarySelectorView" class="view">
    <div class="library-selector-wrapper">
      <div class="connected-libraries-header">
        <h1 class="library-selector-title">Connected Libraries</h1>
      </div>
      <div class="library-selector-content">
        <div id="libraryList" class="library-list"></div>
      </div>
    </div>
  </div>

  <!-- Scan Results View -->
    <div id="scanResultsView" class="view">
      <div class="settings-header">
        <button class="icon-btn" id="backToLibraries">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.8536 7.14645C14.0488 7.34171 14.0488 7.65829 13.8536 7.85355L9.70711 12L13.8536 16.1464C14.0488 16.3417 14.0488 16.6583 13.8536 16.8536C13.6583 17.0488 13.3417 17.0488 13.1464 16.8536L8.64645 12.3535C8.55268 12.2598 8.5 12.1326 8.5 12C8.5 11.8674 8.55268 11.7402 8.64645 11.6464L13.1464 7.14645C13.3417 6.95118 13.6583 6.95118 13.8536 7.14645Z" fill="var(--figma-color-icon-tertiary)" fill-opacity="0.9"/>
          </svg>
        </button>
        <h1 class="library-selector-title">Scan details</h1>
      </div>
    
    <!-- Search Bar -->
    <div class="search-container">
      <div class="search-input-wrapper">
        <div class="search-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M15 10.5C15 12.9853 12.9853 15 10.5 15C8.01472 15 6 12.9853 6 10.5C6 8.01475 8.01472 6.00003 10.5 6.00003C12.9853 6.00003 15 8.01475 15 10.5ZM14.0444 14.7058C13.0872 15.5133 11.8504 16 10.5 16C7.46243 16 5 13.5376 5 10.5C5 7.46246 7.46243 5.00003 10.5 5.00003C13.5376 5.00003 16 7.46246 16 10.5C16 11.8503 15.5134 13.087 14.706 14.0442C14.7596 14.0683 14.8098 14.1024 14.8538 14.1465L17.8538 17.1465C18.0491 17.3417 18.0491 17.6583 17.8538 17.8536C17.6585 18.0488 17.342 18.0488 17.1467 17.8536L14.1467 14.8536C14.1027 14.8095 14.0686 14.7594 14.0444 14.7058Z" fill="currentColor" fill-opacity="0.9"/>
          </svg>
        </div>
        <input type="text" class="search-input" placeholder="Search">
      </div>
      <button class="filter-button" id="filterBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M8 18.5C8 18.7761 8.22386 19 8.5 19C8.77614 19 9 18.7761 9 18.5V11.95C10.1411 11.7183 11 10.7094 11 9.49997C11 8.29049 10.1411 7.28161 9 7.04998V5.49997C9 5.22383 8.77614 4.99997 8.5 4.99997C8.22386 4.99997 8 5.22383 8 5.49997V7.04998C6.85888 7.28161 6 8.29049 6 9.49997C6 10.7094 6.85888 11.7183 8 11.95V18.5ZM7 9.49997C7 10.3284 7.67157 11 8.5 11C9.32843 11 10 10.3284 10 9.49997C10 8.67154 9.32843 7.99997 8.5 7.99997C7.67157 7.99997 7 8.67154 7 9.49997Z" fill="currentColor" fill-opacity="0.9"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M15 5.49997C15 5.22383 15.2239 4.99997 15.5 4.99997C15.7761 4.99997 16 5.22383 16 5.49997V12.05C17.1411 12.2816 18 13.2905 18 14.5C18 15.7094 17.1411 16.7183 16 16.95V18.5C16 18.7761 15.7761 19 15.5 19C15.2239 19 15 18.7761 15 18.5V16.95C13.8589 16.7183 13 15.7094 13 14.5C13 13.2905 13.8589 12.2816 15 12.05V5.49997ZM14 14.5C14 13.6715 14.6716 13 15.5 13C16.3284 13 17 13.6715 17 14.5C17 15.3284 16.3284 16 15.5 16C14.6716 16 14 15.3284 14 14.5Z" fill="currentColor" fill-opacity="0.9"/>
        </svg>
      </button>
    </div>

    <!-- Filter Dropdown Blocking Overlay -->
    <div class="filter-dropdown-overlay" id="filterDropdownOverlay"></div>

    <!-- Filter Dropdown Menu -->
    <div class="filter-dropdown" id="filterDropdown" style="display: none;">
      <div class="filter-menu">
        <div class="filter-menu-item">
          <label class="filter-label">
            <span class="filter-label-text">Components</span>
            <input type="checkbox" class="mapping-checkbox filter-option" value="component" checked>
          </label>
        </div>
        <div class="filter-menu-item">
          <label class="filter-label">
            <span class="filter-label-text">Color</span>
            <input type="checkbox" class="mapping-checkbox filter-option" value="color" checked>
          </label>
        </div>
        <div class="filter-menu-item">
          <label class="filter-label">
            <span class="filter-label-text">Typography</span>
            <input type="checkbox" class="mapping-checkbox filter-option" value="typography" checked>
          </label>
        </div>
      </div>
    </div>
    
    <!-- Scan Heading Row -->
    <div class="scan-heading-row">
      <div class="row-content">
        <div class="header-label">
          <div class="header-label-text" id="source-library-label"></div>
        </div>
        <div class="header-label">
          <div class="target-library-dropdown" id="targetLibraryDropdown">
            <div class="dropdown-trigger" id="targetLibraryTrigger">
              <span class="selected-library-name" id="target-library-label">Select Library</span>
              <svg class="chevron-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M9.64645 11.1464C9.84171 10.9512 10.1583 10.9512 10.3536 11.1464L12 12.7929L13.6464 11.1464C13.8417 10.9512 14.1583 10.9512 14.3536 11.1464C14.5488 11.3417 14.5488 11.6583 14.3536 11.8536L12.3536 13.8536C12.1583 14.0488 11.8417 14.0488 11.6464 13.8536L9.64645 11.8536C9.45118 11.6583 9.45118 11.3417 9.64645 11.1464Z" fill="currentColor" fill-opacity="0.9"/>
              </svg>
            </div>
            <div class="dropdown-menu" id="targetLibraryMenu">
              <!-- Options injected via JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Component Mappings -->
    <div class="component-mappings">
      <!-- Component Mapping Item -->
      <div class="mapping-item">
        <div class="mapping-left">
          <input type="checkbox" class="mapping-checkbox" checked>
          <div class="component-info">
            <svg class="component-icon" fill="none">
              <path d="M8 1.5L14 5V11L8 14.5L2 11V5L8 1.5Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
            </svg>
            <span class="component-name">Component name</span>
          </div>
        </div>
        <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.8536 11.6464C18.0488 11.8417 18.0488 12.1583 17.8536 12.3536L14.3536 15.8536C14.1583 16.0488 13.8417 16.0488 13.6464 15.8536C13.4512 15.6583 13.4512 15.3417 13.6464 15.1464L16.2929 12.5H6.5C6.22386 12.5 6 12.2761 6 12C6 11.7239 6.22386 11.5 6.5 11.5H16.2929L13.6464 8.85355C13.4512 8.65829 13.4512 8.34171 13.6464 8.14645C13.8417 7.95118 14.1583 7.95118 14.3536 8.14645L17.8536 11.6464Z" fill="var(--figma-color-icon)"/>
        </svg>
        <div class="mapping-right">
          <div class="component-info">
            <svg class="component-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M8 1.5L14 5V11L8 14.5L2 11V5L8 1.5Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
            </svg>
            <span class="component-name">Component name</span>
          </div>
        </div>
      </div>
      
      <div class="mapping-item">
        <div class="mapping-left">
          <input type="checkbox" class="mapping-checkbox" checked>
          <div class="component-info">
            <svg class="component-icon" width="16" height="16" viewBox="0 0 4 16" fill="none">
              <path d="M8 1.5L14 5V11L8 14.5L2 11V5L8 1.5Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
            </svg>
            <span class="component-name">Component name</span>
          </div>
        </div>
        <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.8536 11.6464C18.0488 11.8417 18.0488 12.1583 17.8536 12.3536L14.3536 15.8536C14.1583 16.0488 13.8417 16.0488 13.6464 15.8536C13.4512 15.6583 13.4512 15.3417 13.6464 15.1464L16.2929 12.5H6.5C6.22386 12.5 6 12.2761 6 12C6 11.7239 6.22386 11.5 6.5 11.5H16.2929L13.6464 8.85355C13.4512 8.65829 13.4512 8.34171 13.6464 8.14645C13.8417 7.95118 14.1583 7.95118 14.3536 8.14645L17.8536 11.6464Z" fill="var(--figma-color-icon)"/>
        </svg>
        <div class="mapping-right">
          <div class="component-info">
            <svg class="component-icon" width="16" height="16" viewBox="0 0 4 16" fill="none">
              <path d="M8 1.5L14 5V11L8 14.5L2 11V5L8 1.5Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
            </svg>
            <span class="component-name">Component name</span>
          </div>
        </div>
      </div>
      
      <div class="mapping-item">
        <div class="mapping-left">
          <input type="checkbox" class="mapping-checkbox" checked>
          <div class="component-info">
            <span class="text-icon">T</span>
            <span class="component-name">Component name</span>
          </div>
        </div>
        <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.8536 11.6464C18.0488 11.8417 18.0488 12.1583 17.8536 12.3536L14.3536 15.8536C14.1583 16.0488 13.8417 16.0488 13.6464 15.8536C13.4512 15.6583 13.4512 15.3417 13.6464 15.1464L16.2929 12.5H6.5C6.22386 12.5 6 12.2761 6 12C6 11.7239 6.22386 11.5 6.5 11.5H16.2929L13.6464 8.85355C13.4512 8.65829 13.4512 8.34171 13.6464 8.14645C13.8417 7.95118 14.1583 7.95118 14.3536 8.14645L17.8536 11.6464Z" fill="var(--figma-color-icon)"/>
        </svg>
        <div class="mapping-right">
          <div class="component-info">
            <span class="text-icon">T</span>
            <span class="component-name">Component name</span>
          </div>
        </div>
      </div>
      
      <div class="mapping-item">
        <div class="mapping-left">
          <input type="checkbox" class="mapping-checkbox" checked>
          <div class="component-info">
            <span class="text-icon">T</span>
            <span class="component-name">Component name</span>
          </div>
        </div>
        <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.8536 11.6464C18.0488 11.8417 18.0488 12.1583 17.8536 12.3536L14.3536 15.8536C14.1583 16.0488 13.8417 16.0488 13.6464 15.8536C13.4512 15.6583 13.4512 15.3417 13.6464 15.1464L16.2929 12.5H6.5C6.22386 12.5 6 12.2761 6 12C6 11.7239 6.22386 11.5 6.5 11.5H16.2929L13.6464 8.85355C13.4512 8.65829 13.4512 8.34171 13.6464 8.14645C13.8417 7.95118 14.1583 7.95118 14.3536 8.14645L17.8536 11.6464Z" fill="var(--figma-color-icon)"/>
        </svg>
        <div class="mapping-right">
          <div class="component-info">
            <span class="text-icon">T</span>
            <span class="component-name">Component name</span>
          </div>
        </div>
      </div>
      
      <div class="mapping-item">
        <div class="mapping-left">
          <input type="checkbox" class="mapping-checkbox" checked>
          <div class="component-info">
            <div class="color-swatch" style="background-color: #E74C3C;"></div>
            <span class="component-name">Color style</span>
          </div>
        </div>
        <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.8536 11.6464C18.0488 11.8417 18.0488 12.1583 17.8536 12.3536L14.3536 15.8536C14.1583 16.0488 13.8417 16.0488 13.6464 15.8536C13.4512 15.6583 13.4512 15.3417 13.6464 15.1464L16.2929 12.5H6.5C6.22386 12.5 6 12.2761 6 12C6 11.7239 6.22386 11.5 6.5 11.5H16.2929L13.6464 8.85355C13.4512 8.65829 13.4512 8.34171 13.6464 8.14645C13.8417 7.95118 14.1583 7.95118 14.3536 8.14645L17.8536 11.6464Z" fill="var(--figma-color-icon)"/>
        </svg>
        <div class="mapping-right">
          <input type="checkbox" class="mapping-checkbox" checked>
          <div class="component-info">
            <div class="color-swatch" style="background-color: #E74C3C;"></div>
            <span class="component-name">Color style</span>
          </div>
        </div>
      </div>
      
      <div class="mapping-item">
        <div class="mapping-left">
          <input type="checkbox" class="mapping-checkbox" checked>
          <div class="component-info">
            <div class="color-swatch" style="background-color: #E74C3C;"></div>
            <span class="component-name">Color style</span>
          </div>
        </div>
        <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.8536 11.6464C18.0488 11.8417 18.0488 12.1583 17.8536 12.3536L14.3536 15.8536C14.1583 16.0488 13.8417 16.0488 13.6464 15.8536C13.4512 15.6583 13.4512 15.3417 13.6464 15.1464L16.2929 12.5H6.5C6.22386 12.5 6 12.2761 6 12C6 11.7239 6.22386 11.5 6.5 11.5H16.2929L13.6464 8.85355C13.4512 8.65829 13.4512 8.34171 13.6464 8.14645C13.8417 7.95118 14.1583 7.95118 14.3536 8.14645L17.8536 11.6464Z" fill="var(--figma-color-icon)"/>
        </svg>
        <div class="mapping-right">
          <input type="checkbox" class="mapping-checkbox" checked>
          <div class="component-info">
            <div class="color-swatch" style="background-color: #E74C3C;"></div>
            <span class="component-name">Color style</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Empty State for No Search Results -->
    <div class="no-items" id="noSearchResults" style="display: none;">
      No matches for your search
    </div>
    
    <!-- Swap Button -->
    <div class="swap-button-container">
      <button id="swapLibraryBtn" class="swap-library-btn">Swap library</button>
    </div>
  </div>

  <!-- Library List View -->
  <div id="libraryView" class="view">
    <h1>
      <button class="back-btn" id="backToScan"></button>
      Component Libraries Found
    </h1>
    <div id="libraryList"></div>
    <button id="backToScanFromLibraries" class="secondary-button">Back to Scan</button>
  </div>

  <!-- Style Library List View -->
  <div id="styleLibraryView" class="view">
    <h1>
      <button class="back-btn" id="backToScanFromStyleLibraries"></button>
      Style Libraries Found
    </h1>
    <div id="styleLibraryList"></div>
    <button id="backToScanFromStyleLibrariesBtn" class="secondary-button">Back to Scan</button>
  </div>

  <!-- Unified Library List View -->
  <div id="unifiedLibraryView" class="view">
    <h1>
      <button class="back-btn" id="backToScanFromUnified"></button>
      Libraries Found
    </h1>
    <div id="unifiedLibraryList"></div>
  </div>

  <!-- Settings View -->
  <div id="settingsView" class="view">
    <!-- Header -->
    <div class="settings-header">
      <button class="icon-btn" id="backToScanFromSettings">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M13.8536 7.14645C14.0488 7.34171 14.0488 7.65829 13.8536 7.85355L9.70711 12L13.8536 16.1464C14.0488 16.3417 14.0488 16.6583 13.8536 16.8536C13.6583 17.0488 13.3417 17.0488 13.1464 16.8536L8.64645 12.3535C8.55268 12.2598 8.5 12.1326 8.5 12C8.5 11.8674 8.55268 11.7402 8.64645 11.6464L13.1464 7.14645C13.3417 6.95118 13.6583 6.95118 13.8536 7.14645Z" fill="var(--figma-color-icon-tertiary)" fill-opacity="0.9"/>
        </svg>
      </button>
      <h1 class="library-selector-title">Settings</h1>
    </div>

    <!-- Content -->
    <div class="settings-content-container">
      <!-- Connected Libraries Section -->
      <div class="settings-connected-libraries-header" style="padding-left: 16px !important;">
        <h1 class="library-selector-title">Connected libraries</h1>
      </div>
      <div id="connectedLibrariesList">
        <!-- Library items will be injected here -->
      </div>
      
      <!-- Debug Section -->
      <div class="settings-input-group" style="margin-top: 20px; border-top: 1px solid var(--figma-color-border); padding-top: 16px;">
        <div class="input-label">Debug</div>
        <button id="debugStorageBtn" class="secondary-button" onclick="debugDumpStorage()" style="width: 100%;">Debug: Dump Storage</button>
        <button id="clearAllBtn" class="secondary-button" style="width: 100%; margin-top: 8px; background-color: var(--figma-color-bg-danger);">Clear All Libraries</button>
      </div>
    </div>

    <!-- Add Library Footer -->
    <div class="swap-button-container">
      <button id="syncCurrentFileBtn" class="swap-library-btn">Sync library</button>
    </div>
  </div>

  <!-- Property Mapping View -->
  <div id="propertyMappingView" class="view">
    <div class="settings-header">
      <button class="icon-btn" id="backToScanFromMapping">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M13.8536 7.14645C14.0488 7.34171 14.0488 7.65829 13.8536 7.85355L9.70711 12L13.8536 16.1464C14.0488 16.3417 14.0488 16.6583 13.8536 16.8536C13.6583 17.0488 13.3417 17.0488 13.1464 16.8536L8.64645 12.3535C8.55268 12.2598 8.5 12.1326 8.5 12C8.5 11.8674 8.55268 11.7402 8.64645 11.6464L13.1464 7.14645C13.3417 6.95118 13.6583 6.95118 13.8536 7.14645Z" fill="var(--figma-color-icon-tertiary)" fill-opacity="0.9"/>
        </svg>
      </button>
      <h1 class="library-selector-title">Property mapping</h1>
    </div>

    <div class="scan-heading-row" style="display: flex; flex-direction: column; align-items: flex-start; justify-content: center; padding-top: 16px; padding-bottom: 4px; padding-left: 16px; padding-right: 16px; margin: 0; gap: 0px; width: 100%; box-sizing: border-box;">
       <!-- Target Component Name -->
       <div style="display: flex; flex-direction: column; justify-content: center; position: relative; flex-shrink: 0; white-space: nowrap;">
         <p id="propMappingComponentName" style="
           font-family: 'Inter', sans-serif; 
           font-weight: 550; 
           font-size: 13px; 
           line-height: 22px; 
           letter-spacing: -0.0325px; 
           color: var(--figma-color-text); 
           margin: 0;
         ">Target component name</p>
       </div>

       <!-- Badge -->
       <div style="
         background-color: var(--figma-color-bg-tertiary); 
         display: flex; 
         height: 16px; 
         align-items: center; 
         padding-right: 4px; 
         border-radius: 5px; 
         flex-shrink: 0;
       ">
         <!-- Icon -->
         <div style="width: 16px; height: 16px; position: relative; flex-shrink: 0; display:flex; align-items:center; justify-content:center;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M8 4.33282C6.67449 3.21952 4.72597 3.2412 3.42473 4.39786L3.16782 4.62622C3.06107 4.72111 3 4.85711 3 4.99993V11.9999C3 12.1968 3.11556 12.3754 3.29517 12.456C3.47479 12.5367 3.68502 12.5044 3.83218 12.3736L4.08909 12.1453C5.03631 11.3033 6.46369 11.3033 7.41091 12.1453L7.66782 12.3736C7.85726 12.542 8.14274 12.542 8.33218 12.3736L8.58909 12.1453C9.53631 11.3033 10.9637 11.3033 11.9109 12.1453L12.1678 12.3736C12.315 12.5044 12.5252 12.5367 12.7048 12.456C12.8844 12.3754 13 12.1968 13 11.9999V4.99993C13 4.85711 12.9389 4.72111 12.8322 4.62622L12.5753 4.39786C11.274 3.2412 9.32551 3.21952 8 4.33282ZM7.41091 5.14527C6.46369 4.3033 5.03631 4.3033 4.08909 5.14527L4 5.22446V10.9822C5.08026 10.3577 6.41974 10.3577 7.5 10.9822V5.22446L7.41091 5.14527ZM8.5 5.22446V10.9822C9.58026 10.3577 10.9197 10.3577 12 10.9822V5.22446L11.9109 5.14527C10.9637 4.3033 9.53631 4.3033 8.58909 5.14527L8.5 5.22446Z" fill="var(--figma-color-icon)" fill-opacity="0.9"/>
            </svg>
         </div>
         
         <!-- Library Name -->
         <div style="
           display: flex; 
           flex-direction: column; 
           justify-content: center; 
           position: relative; 
           flex-shrink: 0; 
           white-space: nowrap; 
           font-family: 'Inter', sans-serif; 
           font-weight: 400; 
           font-size: 11px; 
           color: var(--figma-color-text); 
           letter-spacing: 0.055px;
         ">
           <p id="propMappingLibraryName" style="line-height: 16px; margin: 0;">Target component library</p>
         </div>
       </div>
    </div>

    <div id="propertyMappingList" class="settings-content-container" style="padding: 0;">
       <!-- Injected content -->
    </div>
  </div>

  <!-- Component List View -->
  <div id="componentView" class="view">
    <h1>
      <button class="back-btn" id="backToLibraries"></button>
      <span id="currentLibraryName"></span> Components
    </h1>
    <div id="componentList"></div>
    <button id="backToScanFromComponents" class="secondary-button">Back to Scan</button>
  </div>

  <!-- Style List View -->
  <div id="styleView" class="view">
    <h1>
      <button class="back-btn" id="backToStyleLibraries"></button>
      <span id="currentStyleLibraryName"></span> Styles
    </h1>
    <div id="styleList"></div>
    <button id="backToScanFromStyles" class="secondary-button">Back to Scan</button>
  </div>

  <!-- Configuration View - REMOVED -->
  <!--
  <div id="configView" class="view">
    <h1>
      <button class="back-btn" id="backToScanFromConfig"></button>
      Configure Libraries
    </h1>
    
    <div class="config-tabs">
      <button class="config-tab-btn active" id="showUserConfigBtn">User</button>
      <button class="config-tab-btn" id="showTeamConfigBtn">Team</button>
      <button class="config-tab-btn" id="showOrgConfigBtn">Organization</button>
    </div>

    <div id="userConfigSection" class="config-section active">
      <div id="userLibrariesList"></div>
      <button id="addUserLibraryBtn">Add Library</button>
      <div style="margin-top: 12px; display: flex; gap: 8px;">
        <button id="saveUserLibrariesBtn">Save User Libraries</button>
        <button id="clearUserLibrariesBtn" style="background: #dc3545;">Clear All</button>
      </div>
    </div>

    <div id="teamConfigSection" class="config-section">
      <div id="teamLibrariesList"></div>
      <button id="addTeamLibraryBtn">Add Library</button>
      <div style="margin-top: 12px; display: flex; gap: 8px;">
        <button id="saveTeamLibrariesBtn">Save Team Libraries</button>
        <button id="clearTeamLibrariesBtn" style="background: #dc3545;">Clear All</button>
      </div>
    </div>

    <div id="orgConfigSection" class="config-section">
      <div class="hint">Organization libraries are predefined</div>
      <div id="orgLibrariesList">
      </div>
    </div>
  </div>
  -->

  <!-- Swap Modal -->
  <div id="swapModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Swap Component</div>
      <div id="swapComponentInfo"></div>
      <div id="targetLibraryList"></div>
      <div class="modal-buttons">
        <button id="cancelSwapBtn" style="background: #6c757d;">Cancel</button>
        <button id="confirmSwapBtn">Perform Swap</button>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div id="libraryContextMenu" class="filter-dropdown" style="display: none; position: fixed; z-index: 2000; right: auto;">
    <div class="filter-menu">
      <div class="filter-menu-item" id="removeLibraryBtn">
        <span class="filter-label-text">Remove</span>
      </div>
    </div>
  </div>

  <!-- Scan Result Context Menu -->
  <div id="scanResultContextMenu" class="filter-dropdown" style="display: none; position: fixed; z-index: 2000; right: auto;">
    <div class="filter-menu">
      <div class="filter-menu-item" id="preserveStyleBtn">
        <span class="filter-label-text">Preserve style overrides</span>
        <div class="menu-checkbox-container">
           <div class="menu-checkbox"></div>
        </div>
      </div>
      <div class="dropdown-divider"></div>
      <div class="filter-menu-item" id="configurePropsBtn">
        <span class="filter-label-text">Configure properties</span>
      </div>
    </div>
  </div>

  <!-- Component Selection Menu -->
  <div id="componentSelectionMenu" class="dropdown-menu" style="position: fixed; display: none; z-index: 2000; max-height: 300px; overflow-y: auto;">
    <!-- Options injected via JS -->
  </div>

  <!-- Add Library Modal - REMOVED -->
  <!--
  <div class="modal-overlay" id="addLibraryModal">
    <div class="modal-container">
      <div class="modal-header">
        <span class="modal-title">Connect library</span>
        <button class="modal-close-btn" id="closeAddLibraryModal">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.3536 6.64645C17.5488 6.84171 17.5488 7.15829 17.3536 7.35355L12.7071 12L17.3536 16.6464C17.5488 16.8417 17.5488 17.1583 17.3536 17.3536C17.1583 17.5488 16.8417 17.5488 16.6464 17.3536L12 12.7071L7.35355 17.3536C7.15829 17.5488 6.84171 17.5488 6.64645 17.3536C6.45118 17.1583 6.45118 16.8417 6.64645 16.6464L11.2929 12L6.64645 7.35365C6.45119 7.15839 6.45118 6.84181 6.64644 6.64654C6.84171 6.45128 7.15829 6.45128 7.35355 6.64654L12 11.2929L16.6464 6.64645C16.8417 6.45118 17.1583 6.45118 17.3536 6.64645Z" fill="currentColor" fill-opacity="0.9"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div>
            <div class="input-label">Library share link</div>
            <input type="text" class="modal-input" placeholder="https://www.figma.com/design/...">
            <div class="input-helper-text">Connect your Figma library with a share link</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-connect-btn" id="connectLibraryBtn">Connect</button>
      </div>
    </div>
  </div>
  -->

  <script>
    let componentData = null;
    let unifiedData = null;
    let currentSwapData = null;
    let pendingScanData = null; // Store scan data temporarily for library selection

    // Library Selector Functions
    function extractUniqueLibraries(scanData) {
      // If libraries array is provided from backend (with thumbnails), use it
      if (scanData.libraries && scanData.libraries.length > 0) {
        return scanData.libraries;
      }
      
      // Fallback: Get unique libraries from both components and tokens
      const componentLibraries = [...new Set(scanData.components?.map(c => c.library).filter(l => l) || [])];
      const tokenLibraries = [...new Set(scanData.tokens?.map(t => t.library).filter(l => l) || [])];
      const allLibraries = [...new Set([...componentLibraries, ...tokenLibraries])];
      
      // Create library info with counts
      const libraryInfo = {};
      allLibraries.forEach(lib => {
        const componentCount = scanData.components?.filter(c => c.library === lib).length || 0;
        const tokenCount = scanData.tokens?.filter(t => t.library === lib).length || 0;
        libraryInfo[lib] = {
          name: lib,
          componentCount,
          tokenCount,
          totalCount: componentCount + tokenCount,
          thumbnail: null
        };
      });
      
      return Object.values(libraryInfo);
    }

    function showLibrarySelector(scanData) {
      console.log(' Showing library selector with scan data');
      const libraries = extractUniqueLibraries(scanData);
      
      if (libraries.length === 0) {
        alert('No libraries found in scan results');
        return;
      }
      
      // If only one library, skip selector and go directly to results
      if (libraries.length === 1) {
        console.log(' Only one library found, skipping selector');
        unifiedData = scanData;
        window.unifiedScanData = scanData;
        window.selectedSourceLibrary = libraries[0].name;
        showView('scanResultsView');
        updateScanResultsView(scanData, libraries[0].name);
        return;
      }
      
      // Build library list HTML
      const libraryListEl = document.getElementById('libraryList');
      libraryListEl.innerHTML = '';
      
      libraries.forEach(libInfo => {
        const div = document.createElement('div');
        div.className = 'library-selector-item';
        
        // Try to find thumbnail in connected libraries if not present
        let thumbnail = libInfo.thumbnail;
        if (!thumbnail && typeof connectedLibraries !== 'undefined') {
            const connectedLib = connectedLibraries.find(l => l.name === libInfo.name);
            if (connectedLib && connectedLib.thumbnail) {
                thumbnail = connectedLib.thumbnail;
            }
        }

        const thumbStyle = thumbnail 
            ? `background-image: url('${thumbnail}'); background-size: cover; background-position: center;` 
            : `background: var(--figma-color-bg-secondary); display: flex; align-items: center; justify-content: center;`;
            
        const thumbContent = thumbnail 
            ? '' 
            : `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="var(--figma-color-icon-secondary)" stroke-width="1.5" stroke-linejoin="round"/><path d="M2 17L12 22L22 17" stroke="var(--figma-color-icon-secondary)" stroke-width="1.5" stroke-linejoin="round"/><path d="M2 12L12 17L22 12" stroke="var(--figma-color-icon-secondary)" stroke-width="1.5" stroke-linejoin="round"/></svg>`;

        div.innerHTML = `
          <div class="library-selector-thumbnail" style="${thumbStyle}">${thumbContent}</div>
          <div class="library-selector-info">
            <div class="library-selector-name">${libInfo.name}</div>
            <div class="library-selector-count">${libInfo.componentCount} component${libInfo.componentCount !== 1 ? 's' : ''} / ${libInfo.tokenCount} Style${libInfo.tokenCount !== 1 ? 's' : ''}</div>
          </div>
          <div class="library-selector-arrow">
            <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10.1464 16.3536C9.95118 16.1583 9.95118 15.8417 10.1464 15.6464L13.7929 12L10.1464 8.35355C9.95118 8.15829 9.95118 7.84171 10.1464 7.64645C10.3417 7.45118 10.6583 7.45118 10.8536 7.64645L14.8536 11.6464C15.0488 11.8417 15.0488 12.1583 14.8536 12.3536L10.8536 16.3536C10.6583 16.5488 10.3417 16.5488 10.1464 16.3536Z" fill="var(--figma-color-icon)" fill-opacity="0.9"/>
            </svg>
          </div>
        `;
        
        div.addEventListener('click', () => {
          console.log(` Selected library: ${libInfo.name}`);
          unifiedData = scanData;
          window.unifiedScanData = scanData;
          window.selectedSourceLibrary = libInfo.name;
          showView('scanResultsView');
          updateScanResultsView(scanData, libInfo.name);
        });
        
        libraryListEl.appendChild(div);
      });
      
      // Store data for potential library selection
      pendingScanData = scanData;
      showView('librarySelectorView');
    }

    // View management
    function showView(viewId) {
      console.log('Switching to view:', viewId);

      // Close all menus and overlays when switching views
      if (typeof closeScanResultContextMenu === 'function') {
        closeScanResultContextMenu();
      }
      
      const overlay = document.getElementById('filterDropdownOverlay');
      if (overlay) overlay.classList.remove('active');

      const allMenus = document.querySelectorAll('.filter-dropdown, .dropdown-menu, #scanResultContextMenu');
      allMenus.forEach(m => {
        m.style.display = 'none';
        m.classList.remove('show');
      });

      document.querySelectorAll('.filter-button.active, .icon-button.active').forEach(btn => {
        btn.classList.remove('active');
      });

      document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
      const targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.classList.add('active');
        console.log('Successfully switched to:', viewId);
      } else {
        console.error('View not found:', viewId);
      }
      
      // Handle back button visibility in settings view
      if (viewId === 'settingsView') {
          const backBtn = document.getElementById('backToScanFromSettings');
          // If coming from connect view (no libraries), back button should go to connect view or be hidden?
          // For now, let's just ensure it goes back to the previous logical state.
          // Actually, if we are in settings view, we might want to go back to scan or connect view.
          // The existing back button logic might need adjustment if we want specific behavior.
      }
    }

    // Setup Target Library Dropdown
    function setupTargetLibraryDropdown(sourceLibraryName, initialTargetName) {
      const dropdown = document.getElementById('targetLibraryDropdown');
      const trigger = document.getElementById('targetLibraryTrigger');
      const label = document.getElementById('target-library-label');
      const menu = document.getElementById('targetLibraryMenu');
      const overlay = document.getElementById('filterDropdownOverlay');
      
      if (!dropdown || !trigger || !label || !menu) return;
      
      // Use configured libraries or connected libraries
      let availableLibraries = connectedLibraries.length > 0 ? connectedLibraries : [];
      
      // Filter to exclude source
      availableLibraries = availableLibraries.filter(lib => lib.name !== sourceLibraryName);
      
      // If no other libraries, show placeholder
      if (availableLibraries.length === 0) {
        label.textContent = "No target libraries";
        trigger.classList.add('disabled');
      } else {
        trigger.classList.remove('disabled');
      }
      
      // Set initial selection
      let selectedLib = availableLibraries.find(lib => lib.name === initialTargetName);
      if (!selectedLib && availableLibraries.length > 0) {
        selectedLib = availableLibraries[0];
      }
      
      if (selectedLib) {
        label.textContent = selectedLib.name;
      }
      
      // Populate menu
      menu.innerHTML = '';
      availableLibraries.forEach(lib => {
        const option = document.createElement('div');
        option.className = 'dropdown-option';
        if (selectedLib && lib.name === selectedLib.name) option.classList.add('selected');
        
        const checkIcon = `<svg class="dropdown-check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.7773 4.084C12.0071 4.23717 12.0692 4.54761 11.916 4.77737L7.91603 10.7774C7.83293 10.902 7.69834 10.9828 7.54927 10.9976C7.4002 11.0123 7.25237 10.9595 7.14645 10.8536L4.14645 7.85358C3.95118 7.65831 3.95118 7.34173 4.14645 7.14647C4.34171 6.95121 4.65829 6.95121 4.85355 7.14647L7.42229 9.7152L11.084 4.22267C11.2372 3.99291 11.5476 3.93082 11.7773 4.084Z" fill="currentColor" fill-opacity="0.9"/></svg>`;
        option.innerHTML = `${checkIcon}<span>${lib.name}</span>`;
        
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          label.textContent = lib.name;
          
          // Update selected state
          menu.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');
          
          // Close menu
          menu.classList.remove('show');
          trigger.classList.remove('active');
          
          // Hide overlay
          if (overlay) {
            overlay.classList.remove('active');
            if (menu._closeHandler) {
                overlay.removeEventListener('click', menu._closeHandler);
                menu._closeHandler = null;
            }
          }
          
          console.log('Target library changed to:', lib.name);
          
          if (window.lastScanData) {
              updateScanResultsView(window.lastScanData, sourceLibraryName, lib.name);
          } else {
              console.warn('No scan data available to update view');
          }
        });
        
        menu.appendChild(option);
      });
      
      // Update toggle listener
      trigger.onclick = (e) => {
        if (trigger.classList.contains('disabled')) return;
        e.stopPropagation();
        
        // Global close of other menus
        closeScanResultContextMenu();
        const activeMenus = document.querySelectorAll('.dropdown-menu.show, .filter-dropdown[style*="block"]');
        activeMenus.forEach(m => {
            if (m !== menu) m.classList.remove('show');
            if (m.style.display === 'block') m.style.display = 'none';
        });
        
        const isOpening = !menu.classList.contains('show');
        menu.classList.toggle('show');
        trigger.classList.toggle('active');
        
        // Toggle overlay
        if (overlay) {
            if (isOpening) {
                overlay.classList.add('active');
                
                // Handler to close this specific dropdown
                const closeHandler = () => {
                    menu.classList.remove('show');
                    trigger.classList.remove('active');
                    overlay.classList.remove('active');
                    overlay.removeEventListener('click', closeHandler);
                    menu._closeHandler = null;
                };
                overlay.addEventListener('click', closeHandler);
                menu._closeHandler = closeHandler;
            } else {
                overlay.classList.remove('active');
                if (menu._closeHandler) {
                    overlay.removeEventListener('click', menu._closeHandler);
                    menu._closeHandler = null;
                }
            }
        }
      };
      
      // Close on click outside
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
          menu.classList.remove('show');
          trigger.classList.remove('active');
        }
      });
    }

    // Update scan results view with found components and tokens
    function updateScanResultsView(data, selectedLibrary, explicitTargetLibrary) {
      // console.log('Updating scan results view with:', data);
      console.log('Selected library:', selectedLibrary);
      console.log('Explicit target library:', explicitTargetLibrary);
      
      // Store data globally for re-rendering
      window.lastScanData = data;
      
      // Check unique libraries in the FULL data to decide on back button visibility
      const allComponentLibs = data.components.length > 0 ? [...new Set(data.components.map(c => c.library))] : [];
      const allTokenLibs = data.tokens ? [...new Set(data.tokens.map(t => t.library).filter(l => l))] : [];
      const totalUniqueLibraries = [...new Set([...allComponentLibs, ...allTokenLibs])];
      
      const backBtn = document.getElementById('backToLibraries');
      const scanResultsTitle = document.querySelector('#scanResultsView .library-selector-title');
      
      if (backBtn) {
          if (totalUniqueLibraries.length <= 1) {
              backBtn.style.display = 'none';
              if (scanResultsTitle) {
                  scanResultsTitle.style.marginLeft = '8px';
              }
          } else {
              backBtn.style.display = '';
              if (scanResultsTitle) {
                  scanResultsTitle.style.marginLeft = '';
              }
          }
      }
      
      const scanResultsView = document.getElementById('scanResultsView');
      if (!scanResultsView) {
        console.error('Scan results view not found');
        return;
      }
      
      // Filter data to only include the selected library if specified
      let filteredData = data;
      if (selectedLibrary) {
        filteredData = {
          components: data.components.filter(c => c.library === selectedLibrary),
          tokens: data.tokens ? data.tokens.filter(t => t.library === selectedLibrary) : []
        };
        console.log('Filtered data for selected library:', filteredData);
      }
      
      // Update library header with actual library names and determine mapping direction
      const sourceLibraryLabel = document.getElementById('source-library-label');
      const targetLibraryLabel = document.getElementById('target-library-label');
      
      // Determine source library name
      let sourceLibraryName = selectedLibrary;
      if (!sourceLibraryName) {
        const componentLibraries = filteredData.components.length > 0 ? [...new Set(filteredData.components.map(c => c.library))] : [];
        const tokenLibraries = filteredData.tokens ? [...new Set(filteredData.tokens.map(t => t.library).filter(l => l))] : [];
        const allLibraries = [...new Set([...componentLibraries, ...tokenLibraries])];
        sourceLibraryName = allLibraries.length > 0 ? allLibraries[0] : 'Source Library';
      }

      // Determine target library name
      let targetLibraryName = explicitTargetLibrary;
      
      if (!targetLibraryName) {
          targetLibraryName = 'Select Target';
          // Try to find a different library in connectedLibraries
          if (connectedLibraries && connectedLibraries.length > 0) {
               const otherLib = connectedLibraries.find(l => l.name !== sourceLibraryName);
               if (otherLib) {
                   targetLibraryName = otherLib.name;
               }
          }
      }

      if (sourceLibraryLabel && targetLibraryLabel) {
        sourceLibraryLabel.textContent = sourceLibraryName;
        setupTargetLibraryDropdown(sourceLibraryName, targetLibraryName);
      }
      
      // Find the component mappings container
      const mappingsContainer = scanResultsView.querySelector('.component-mappings');
      if (!mappingsContainer) {
        console.error('Component mappings container not found');
        return;
      }
      
      // Clear existing content and rebuild
      mappingsContainer.innerHTML = '';
      
      const isTargetValid = targetLibraryName !== 'Select Target' && targetLibraryName !== 'No target libraries';

      // Add Components (deduplicated by parent name, but track all variants)
      if (filteredData.components && filteredData.components.length > 0) {
        // Group all variants by parent name
        const parentMap = new Map();
        filteredData.components.forEach((component) => {
          const key = component.displayName + '|' + component.library;
          if (!parentMap.has(key)) {
            parentMap.set(key, []);
          }
          parentMap.get(key).push(component);
        });
        
        // Create one UI item per parent, storing all its variants
        Array.from(parentMap.values()).forEach((variants) => {
          const mappingItem = document.createElement('div');
          mappingItem.className = 'mapping-item';
          mappingItem.dataset.searchHidden = 'false';
          // Store all variant names (separated by comma) for swap logic
          mappingItem.dataset.variantNames = variants.map(v => v.name).join(',');
          const firstVariant = variants[0];
          // Check if target library has this component
          let targetComponentName = '-';
          let isMatchFound = false;
          let bestCandidate = null;
          
          if (isTargetValid) {
              // Use the global connectedLibraries variable directly
              const targetLibObj = connectedLibraries ? connectedLibraries.find(l => l.name === targetLibraryName) : null;
              
              if (targetLibObj && targetLibObj.components) {
                  // Check if any variant in the group exists in the target library
                  // Note: targetLibObj.components is a map of Name -> Key
                  // We want to find the BEST match (e.g. same variant name)
                  // For the parent group row, we just need ONE valid target to enable configuration
                  
                  // Find first matching variant
                  for (const v of variants) {
                      const matchKey = targetLibObj.components[v.name];
                      if (matchKey) {
                          isMatchFound = true;
                          targetComponentName = firstVariant.displayName; // Use source name paradigm for now
                          bestCandidate = {
                              name: v.displayName, // or v.name? v.displayName is parent name usually
                              key: matchKey,
                              libraryName: targetLibraryName
                          };
                          break; // Found a valid target for this component set
                      }
                  }
              }
          }

          const chevronIcon = `<svg class="chevron-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.64645 11.1464C9.84171 10.9512 10.1583 10.9512 10.3536 11.1464L12 12.7929L13.6464 11.1464C13.8417 10.9512 14.1583 10.9512 14.3536 11.1464C14.5488 11.3417 14.5488 11.6583 14.3536 11.8536L12.3536 13.8536C12.1583 14.0488 11.8417 14.0488 11.6464 13.8536L9.64645 11.8536C9.45118 11.6583 9.45118 11.3417 9.64645 11.1464Z" fill="var(--figma-color-icon)" fill-opacity="0.9"/></svg>`;
          
          const componentIcon = `<svg class="component-icon" viewBox="0 0 24 24" fill="none"><path d="M11.1163 13.5907C11.6045 13.1027 12.3958 13.1026 12.8839 13.5907L14.2628 14.9696C14.7506 15.4577 14.7507 16.2491 14.2628 16.7372L12.8839 18.1161C12.3958 18.604 11.6045 18.6039 11.1163 18.1161L9.73741 16.7372C9.24928 16.249 9.24935 15.4577 9.73741 14.9696L11.1163 13.5907ZM12.1769 14.2977C12.0793 14.2001 11.921 14.2002 11.8233 14.2977L10.4444 15.6766C10.3469 15.7743 10.3468 15.9325 10.4444 16.0301L11.8233 17.409C11.921 17.5064 12.0793 17.5065 12.1769 17.409L13.5558 16.0301C13.6531 15.9326 13.6531 15.7742 13.5558 15.6766L12.1769 14.2977ZM7.2628 9.73716C7.75097 9.24916 8.54227 9.24906 9.03038 9.73716L10.4093 11.1161C10.8972 11.6042 10.8972 12.3956 10.4093 12.8836L9.03038 14.2626C8.54229 14.7505 7.75094 14.7504 7.2628 14.2626L5.88389 12.8836C5.39577 12.3955 5.39583 11.6042 5.88389 11.1161L7.2628 9.73716ZM14.9698 9.73716C15.458 9.2491 16.2493 9.24904 16.7374 9.73716L18.1163 11.1161C18.6042 11.6042 18.6043 12.3956 18.1163 12.8836L16.7374 14.2626C16.2493 14.7506 15.458 14.7504 14.9698 14.2626L13.5909 12.8836C13.1028 12.3955 13.1028 11.6042 13.5909 11.1161L14.9698 9.73716ZM8.32334 10.4442C8.22576 10.3466 8.06747 10.3467 7.96983 10.4442L6.59092 11.8231C6.49339 11.9207 6.49332 12.079 6.59092 12.1766L7.96983 13.5555C8.06778 13.6529 8.22613 13.6529 8.32334 13.5554L9.70257 12.1765C9.79965 12.079 9.79989 11.9206 9.70257 11.823L8.32367 10.4441ZM16.0307 10.4441C15.9331 10.3465 15.7748 10.3466 15.6772 10.4441L14.2983 11.823C14.2007 11.9207 14.2007 12.0789 14.2983 12.1765L15.6772 13.5554C15.7748 13.6527 15.9331 13.6529 16.0307 13.5554L17.4096 12.1765C17.507 12.079 17.5069 11.9206 17.4096 11.823L16.0307 10.4441ZM11.1166 5.88364C11.6048 5.39559 12.3961 5.39553 12.8842 5.88364L14.2631 7.26253C14.7509 7.75067 14.7511 8.54203 14.2631 9.03009L12.8842 10.409L12.7895 10.4949C12.3313 10.8686 11.6696 10.8684 11.2114 10.4949L11.1166 10.409L9.73773 9.03009C9.2801 8.57247 9.2514 7.84822 9.65179 7.35726L9.73773 7.26253L11.1166 5.88364ZM12.1772 6.59067C12.0796 6.49307 11.9213 6.49313 11.8237 6.59067L10.4444 7.96955C10.3472 8.06719 10.3472 8.22547 10.4448 8.32307L11.8237 9.70195C11.921 9.79927 12.0796 9.7994 12.1772 9.70195L13.5561 8.32307C13.6535 8.22552 13.6534 8.06718 13.5561 7.96955L12.1772 6.59067Z" fill="currentColor"/></svg>`;

          let targetElementHTML = '';
          
          if (isTargetValid) {
             const displayName = isMatchFound ? targetComponentName : 'Select Component';
             const displayStyle = isMatchFound ? '' : 'color: var(--figma-color-text-tertiary); font-style: italic;';
             
             targetElementHTML = `
              <div class="target-element">
                <div class="dropdown-trigger component-dropdown-trigger" style="padding-left: 0;">
                   <div class="icon-container" style="margin-right: 4px;">
                      ${componentIcon}
                   </div>
                   <span class="selected-library-name component-name" style="${displayStyle}">${displayName}</span>
                   ${chevronIcon}
                </div>
              </div>
             `;
          } else {
             targetElementHTML = `
              <div class="target-element">
                <span class="component-name" style="color: var(--figma-color-text-tertiary); font-size: 13px; font-style: italic; width: 100%; text-align: center;">-</span>
              </div>
             `;
          }

          mappingItem.innerHTML = `
            <input type="checkbox" class="mapping-checkbox" checked>
            <div class="row-content">
              <div class="source-element">
                <div class="icon-container">
                  <svg class="component-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11.1166 13.5906C11.6048 13.1025 12.3961 13.1025 12.8842 13.5906L14.2631 14.9695C14.7509 15.4576 14.7511 16.249 14.2631 16.737L12.8842 18.1159L12.7895 18.2018C12.3313 18.5755 11.6696 18.5754 11.2114 18.2018L11.1166 18.1159L9.73773 16.737C9.2801 16.2794 9.2514 15.5552 9.65179 15.0642L9.73773 14.9695L11.1166 13.5906ZM12.1772 14.2976C12.0796 14.2 11.9213 14.2001 11.8237 14.2976L10.4448 15.6765C10.3472 15.7741 10.3472 15.9324 10.4448 16.03L11.8237 17.4089C11.9213 17.5062 12.0796 17.5063 12.1772 17.4089L13.5561 16.03C13.6535 15.9325 13.6534 15.7741 13.5561 15.6765L12.1772 14.2976ZM7.26313 9.73711C7.75129 9.24906 8.54258 9.24899 9.0307 9.73711L10.4096 11.116C10.8974 11.6041 10.8976 12.3955 10.4096 12.8836L9.0307 14.2624L8.93597 14.3484C8.47782 14.722 7.81607 14.7219 7.35785 14.3484L7.26313 14.2624L5.88422 12.8836C5.4266 12.4259 5.3979 11.7017 5.79829 11.2107L5.88422 11.116L7.26313 9.73711ZM14.9701 9.73711C15.4583 9.24906 16.2496 9.24899 16.7377 9.73711L18.1166 11.116C18.6044 11.6041 18.6046 12.3955 18.1166 12.8836L16.7377 14.2624L16.643 14.3484C16.1848 14.722 15.5231 14.7219 15.0649 14.3484L14.9701 14.2624L13.5912 12.8836C13.1336 12.4259 13.1049 11.7017 13.5053 11.2107L13.5912 11.116L14.9701 9.73711ZM8.32367 10.4441C8.22607 10.3465 8.06779 10.3466 7.97016 10.4441L6.59125 11.823C6.49372 11.9207 6.49365 12.0789 6.59125 12.1765L7.97016 13.5554C8.06778 13.6527 8.22613 13.6529 8.32367 13.5554L9.70257 12.1765C9.80001 12.079 9.79989 11.9206 9.70257 11.823L8.32367 10.4441ZM16.0307 10.4441C15.9331 10.3465 15.7748 10.3466 15.6772 10.4441L14.2983 11.823C14.2007 11.9207 14.2007 12.0789 14.2983 12.1765L15.6772 13.5554C15.7748 13.6527 15.9331 13.6529 16.0307 13.5554L17.4096 12.1765C17.507 12.079 17.5069 11.9206 17.4096 11.823L16.0307 10.4441ZM11.1166 5.88364C11.6048 5.39559 12.3961 5.39553 12.8842 5.88364L14.2631 7.26253C14.7509 7.75067 14.7511 8.54203 14.2631 9.03009L12.8842 10.409L12.7895 10.4949C12.3313 10.8686 11.6696 10.8684 11.2114 10.4949L11.1166 10.409L9.73773 9.03009C9.2801 8.57247 9.2514 7.84822 9.65179 7.35726L9.73773 7.26253L11.1166 5.88364ZM12.1772 6.59067C12.0796 6.49307 11.9213 6.49313 11.8237 6.59067L10.4444 7.96955C10.3472 8.06719 10.3472 8.22547 10.4448 8.32307L11.8237 9.70195C11.9213 9.79927 12.0796 9.7994 12.1772 9.70195L13.5561 8.32307C13.6535 8.22552 13.6534 8.06718 13.5561 7.96955L12.1772 6.59067Z" fill="currentColor"/>
                  </svg>
                </div>
                <span class="component-name">${firstVariant.displayName}</span>
              </div>
              <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.8536 11.6464C18.0488 11.8417 18.0488 12.1583 17.8536 12.3536L14.3536 15.8536C14.1583 16.0488 13.8417 16.0488 13.6464 15.8536C13.4512 15.6583 13.4512 15.3417 13.6464 15.1464L16.2929 12.5H6.5C6.22386 12.5 6 12.2761 6 12C6 11.7239 6.22386 11.5 6.5 11.5H16.2929L13.6464 8.85355C13.4512 8.65829 13.4512 8.34171 13.6464 8.14645C13.8417 7.95118 14.1583 7.95118 14.3536 8.14645L17.8536 11.6464Z" fill="var(--figma-color-icon)"/>
              </svg>
              ${targetElementHTML}
              <button class="library-more-btn filter-button" style="margin-left: 8px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M7.5 12C7.5 12.8284 6.82843 13.5 6 13.5C5.17157 13.5 4.5 12.8284 4.5 12C4.5 11.1716 5.17157 10.5 6 10.5C6.82843 10.5 7.5 11.1716 7.5 12Z" fill="currentColor" fill-opacity="0.9"/>
                  <path d="M13.5 12C13.5 12.8284 12.8284 13.5 12 13.5C11.1716 13.5 10.5 12.8284 10.5 12C10.5 11.1716 11.1716 10.5 12 10.5C12.8284 10.5 13.5 11.1716 13.5 12Z" fill="currentColor" fill-opacity="0.9"/>
                  <path d="M18 13.5C18.8284 13.5 19.5 12.8284 19.5 12C19.5 11.1716 18.8284 10.5 18 10.5C17.1716 10.5 16.5 11.1716 16.5 12C16.5 12.8284 17.1716 13.5 18 13.5Z" fill="currentColor" fill-opacity="0.9"/>
                </svg>
              </button>
            </div>
          `;
          
          // Dropdown handler
          const trigger = mappingItem.querySelector('.component-dropdown-trigger');
          if (trigger) {
             trigger.addEventListener('click', (e) => {
                 e.stopPropagation();
                 // Resolve the target library object from the targetLibraryName
                 const currentTargetLibObj = connectedLibraries ? connectedLibraries.find(l => l.name === targetLibraryName) : null;
                 showComponentSelectionMenu(e, currentTargetLibObj, mappingItem, firstVariant);
             });
          }

          // Context menu handler
          const moreBtn = mappingItem.querySelector('.library-more-btn');

          // Attach the scan result data directly to the DOM element so it persists and is accessible
          mappingItem.scanResult = { 
              type: 'component', 
              variants: variants, // contains objects with instanceId
              id: firstVariant.id,
              instanceId: firstVariant.instanceId, // Use the instance ID from the first found variant (representative)
              library: firstVariant.library,
              bestCandidate: bestCandidate
          };

          if (moreBtn) {
            moreBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              showScanResultContextMenu(e, mappingItem.scanResult);
            });
          }

          mappingsContainer.appendChild(mappingItem);
        });
      }
      
      // Add Tokens as color styles
      if (filteredData.tokens && filteredData.tokens.length > 0) {
        // Collect all target color requests
        const targetColorRequests = filteredData.tokens.map(token => ({
          token,
          styleName: token.name
        }));

        // Create a map to store target colors as they arrive
        const targetColors = new Map();
        let receivedCount = 0;

        // Set up message handler for all target color responses
        const messageHandler = (event) => {
          // console.log(' UI received message:', event.data);
          const msg = event.data.pluginMessage;
          if (msg && msg.type === 'TARGET_COLOR_RESULT') {
            const { tokenId, color } = msg;
            console.log(` Received target color: tokenId=${tokenId}, color=${color}`);
            targetColors.set(tokenId, color);
            receivedCount++;

            // Update the corresponding swatch
            const mappingItems = mappingsContainer.querySelectorAll('.mapping-item');
            console.log(` Searching through ${mappingItems.length} mapping items`);
            mappingItems.forEach(item => {
              const targetSwatch = item.querySelector('.target-color-swatch');
              if (targetSwatch) {
                console.log(` Found target swatch, tokenId=${targetSwatch.dataset.tokenId}, color=${color}`);
                if (targetSwatch.dataset.tokenId === tokenId && color) {
                  console.log(` Setting background color to ${color}`);
                  targetSwatch.style.backgroundColor = color;
                }
              }
            });
          }
        };
        window.addEventListener('message', messageHandler);

        // Request all target colors
        console.log(` Requesting target colors for ${targetColorRequests.length} tokens`);
        targetColorRequests.forEach(({ token, styleName }) => {
          console.log(`   - Requesting color for token: ${token.id} (${styleName})`);
          parent.postMessage({ 
            pluginMessage: { 
              type: 'GET_TARGET_COLOR', 
              tokenId: token.id,
              styleName: styleName,
              sourceLibrary: sourceLibraryName,
              targetLibrary: targetLibraryName
            } 
          }, '*');
        });

        // Render all tokens immediately with source colors
        filteredData.tokens.forEach((token, index) => {
          const mappingItem = document.createElement('div');
          mappingItem.className = 'mapping-item';
          mappingItem.dataset.searchHidden = 'false';
          
          // Determine icon based on token type
          let sourceIcon = '';
          let targetIcon = '';
          
          if (token.type === 'typography') {
            sourceIcon = '<img src="https://raw.githubusercontent.com/RobertNavaille/Advanced-Library-Swap/main/Images/textIcon.svg" class="text-icon" style="width: 24px; height: 24px; color: var(--figma-color-icon); filter: brightness(0) saturate(100%) invert(75%) sepia(0%) saturate(0%);" />';
            targetIcon = '<img src="https://raw.githubusercontent.com/RobertNavaille/Advanced-Library-Swap/main/Images/textIcon.svg" class="text-icon" style="width: 24px; height: 24px; color: var(--figma-color-icon); filter: brightness(0) saturate(100%) invert(75%) sepia(0%) saturate(0%);" />';
          } else {
            // Default to color swatch for color tokens
            sourceIcon = `<div class="color-swatch" style="background-color: ${token.value || '#E74C3C'};"></div>`;
            targetIcon = `<div class="color-swatch target-color-swatch" data-token-id="${token.id}" style="background-color: #CCCCCC;"></div>`;
          }
          
          const targetElementHTML = isTargetValid ? `
              <div class="target-element">
                <div class="icon-container">
                  ${targetIcon}
                </div>
                <span class="component-name">${token.name}</span>
              </div>
          ` : `
              <div class="target-element">
                <span class="component-name" style="color: var(--figma-color-text-tertiary); font-size: 13px; font-style: italic; width: 100%; text-align: center;">-</span>
              </div>
          `;

          mappingItem.innerHTML = `
            <input type="checkbox" class="mapping-checkbox" checked>
            <div class="row-content">
              <div class="source-element">
                <div class="icon-container">
                  ${sourceIcon}
                </div>
                <span class="component-name">${token.name}</span>
              </div>
              <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.8536 11.6464C18.0488 11.8417 18.0488 12.1583 17.8536 12.3536L14.3536 15.8536C14.1583 16.0488 13.8417 16.0488 13.6464 15.8536C13.4512 15.6583 13.4512 15.3417 13.6464 15.1464L16.2929 12.5H6.5C6.22386 12.5 6 12.2761 6 12C6 11.7239 6.22386 11.5 6.5 11.5H16.2929L13.6464 8.85355C13.4512 8.65829 13.4512 8.34171 13.6464 8.14645C13.8417 7.95118 14.1583 7.95118 14.3536 8.14645L17.8536 11.6464Z" fill="var(--figma-color-icon)"/>
              </svg>
              ${targetElementHTML}
              <button class="library-more-btn filter-button" style="margin-left: 8px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M7.5 12C7.5 12.8284 6.82843 13.5 6 13.5C5.17157 13.5 4.5 12.8284 4.5 12C4.5 11.1716 5.17157 10.5 6 10.5C6.82843 10.5 7.5 11.1716 7.5 12Z" fill="currentColor" fill-opacity="0.9"/>
                  <path d="M13.5 12C13.5 12.8284 12.8284 13.5 12 13.5C11.1716 13.5 10.5 12.8284 10.5 12C10.5 11.1716 11.1716 10.5 12 10.5C12.8284 10.5 13.5 11.1716 13.5 12Z" fill="currentColor" fill-opacity="0.9"/>
                  <path d="M18 13.5C18.8284 13.5 19.5 12.8284 19.5 12C19.5 11.1716 18.8284 10.5 18 10.5C17.1716 10.5 16.5 11.1716 16.5 12C16.5 12.8284 17.1716 13.5 18 13.5Z" fill="currentColor" fill-opacity="0.9"/>
                </svg>
              </button>
            </div>
          `;
          
          // Context menu handler
          const moreBtn = mappingItem.querySelector('.library-more-btn');
          if (moreBtn) {
            moreBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              showScanResultContextMenu(e, { type: 'token', token: token });
            });
          }

          mappingsContainer.appendChild(mappingItem);
        });

        // Clean up listener after longer timeout (10 seconds)
        const cleanupTimeout = setTimeout(() => {
          console.log(` Cleanup timeout: received ${receivedCount}/${targetColorRequests.length} colors`);
          window.removeEventListener('message', messageHandler);
        }, 10000);
      }
      
      // If no components or tokens found, show placeholder
      if ((!filteredData.components || filteredData.components.length === 0) && (!filteredData.tokens || filteredData.tokens.length === 0)) {
        mappingsContainer.innerHTML = `
          <div class="mapping-item">
            <div class="mapping-left">
              <div class="component-info">
                <span class="component-name" style="color: var(--figma-color-text-tertiary);">No components or tokens found in this frame</span>
              </div>
            </div>
          </div>
        `;
      }
      
      console.log('Scan results view updated successfully');
      
      // Apply search and filter logic to show/hide items based on current selections
      // Use setTimeout to ensure DOM is fully updated before applying filters
      setTimeout(() => {
        const searchInput = document.querySelector('.search-input');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
        // First apply search, which internally calls filter logic
        if (searchTerm) {
          applySearchLogic(searchTerm);
        } else {
          applyFilterLogic();
        }
      }, 0);
    }

    // Show library list view
    function showLibraries(libraries) {
      const libraryListEl = document.getElementById('libraryList');
      
      if (libraries.length === 0) {
        libraryListEl.innerHTML = '<div class="no-items">No libraries found in selection</div>';
        showView('libraryView');
        return;
      }

      let html = `<div style="font-weight: 600; margin-bottom: 8px;">Found ${libraries.length} librar${libraries.length === 1 ? 'y' : 'ies'}:</div>`;
      
      libraries.forEach(lib => {
        // Determine target library for swapping
        let targetLibrary = null;
        // Try to find a different library in connectedLibraries
        if (connectedLibraries && connectedLibraries.length > 0) {
             const otherLib = connectedLibraries.find(l => l.name !== lib.name);
             if (otherLib) {
                 targetLibrary = otherLib.name;
             }
        }
        
        html += `
          <div class="library-item">
            <div onclick="showComponentsForLibrary('${lib.name}')" style="flex: 1; cursor: pointer;">
              <div class="library-name">${lib.name}</div>
              <div class="library-count">${lib.count} component${lib.count === 1 ? '' : 's'}</div>
            </div>
            ${targetLibrary ? `
              <button onclick="swapAllComponents('${lib.name}', '${targetLibrary}')" 
                      style="margin-left: 12px; padding: 8px 16px; font-size: 11px; white-space: nowrap; background: #18A0FB; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Swap All  ${targetLibrary}
              </button>
            ` : ''}
          </div>
        `;
      });
      
      libraryListEl.innerHTML = html;
      showView('libraryView');
    }

    // Show components for a specific library
    function showComponentsForLibrary(libraryName) {
      const currentLibraryNameEl = document.getElementById('currentLibraryName');
      const componentListEl = document.getElementById('componentList');
      
      currentLibraryNameEl.textContent = libraryName;
      
      if (!componentData || !componentData.componentsByLibrary[libraryName]) {
        componentListEl.innerHTML = '<div class="no-items">No components found</div>';
        showView('componentView');
        return;
      }

      const components = componentData.componentsByLibrary[libraryName];
      
      let html = `<div style="font-weight: 600; margin-bottom: 8px;">${components.length} component${components.length === 1 ? '' : 's'}:</div>`;
      
      components.forEach(comp => {
        // Use displayName if available (for variants), otherwise use name
        const displayName = comp.displayName || comp.name;
        
        // Build component info with variant details
        let infoText = `Key: ${comp.key.substring(0, 12)}...`;
        
        if (comp.type && comp.type !== 'Instance') {
          infoText += ` | Type: ${comp.type}`;
        }
        
        if (comp.isVariant && comp.properties) {
          const variantProps = Object.entries(comp.properties)
            .map(([key, value]) => `${key}=${value}`)
            .join(', ');
          infoText += ` | Variant: ${variantProps}`;
        }
        
        if (comp.isComponentSet && comp.variantCount) {
          infoText += ` | ${comp.variantCount} variants`;
        }
        
        if (comp.instances !== undefined) {
          infoText += ` | ${comp.instances} instance${comp.instances === 1 ? '' : 's'}`;
        }
        
        // Determine CSS class based on component type
        let cssClass = 'component-item';
        if (comp.isVariant) {
          cssClass += ' variant';
        } else if (comp.isComponentSet) {
          cssClass += ' component-set';
        }
        
        html += `
          <div class="${cssClass}">
            <div class="component-name">${displayName}</div>
            <div class="component-info">${infoText}</div>
          </div>
        `;
      });
      
      componentListEl.innerHTML = html;
      showView('componentView');
    }

    // Show unified libraries (components and styles combined) as detailed list
    function showUnifiedLibraries(libraries) {
      const unifiedLibraryListEl = document.getElementById('unifiedLibraryList');
      
      if (libraries.length === 0) {
        unifiedLibraryListEl.innerHTML = '<div class="no-items">No libraries found in selection</div>';
        showView('unifiedLibraryView');
        return;
      }

      // Get the first library that can be swapped
      const swappableLibrary = libraries.length > 0 ? libraries[0] : null;
      let targetLibrary = null;
      
      if (swappableLibrary && connectedLibraries && connectedLibraries.length > 0) {
         const otherLib = connectedLibraries.find(l => l.name !== swappableLibrary.name);
         if (otherLib) {
             targetLibrary = otherLib.name;
         }
      }

      let html = `<div class="scan-results-header">Scan Results:</div>`;
      
      // Show detailed list of all components and styles
      libraries.forEach(lib => {
        if (lib.totalCount === 0) return;

        html += `<div class="library-section-header">${lib.name} Library</div>`;
        
        let itemsAdded = 0;
        
        // Show components from this library (grouped by parent component)
        if (window.unifiedScanData && window.unifiedScanData.componentsByLibrary[lib.name]) {
          const components = window.unifiedScanData.componentsByLibrary[lib.name];
          
          // Group components by their parent name (for variants) or by their own name
          const componentGroups = {};
          
          components.forEach(component => {
            // Use the component.name field which contains the base component name
            // For variants, this is already set to the parent component set name
            const parentName = component.name;
            
            if (!componentGroups[parentName]) {
              componentGroups[parentName] = {
                name: parentName,
                type: component.isVariant ? 'Component Set' : component.type,
                isComponentSet: component.isVariant,
                variants: []
              };
            }
            
            if (component.isVariant) {
              componentGroups[parentName].variants.push(component);
            }
          });
          
          // Display each component group once
          Object.values(componentGroups).forEach(group => {
            const hasVariants = group.variants.length > 0;
            const itemClass = hasVariants ? 'component-item component-set' : 'component-item';
            
            html += `
              <div class="${itemClass}">
                <div style="flex: 1;">
                  <div class="component-name"> ${group.name}</div>
                  <div class="component-info">${group.type}${hasVariants ? `  ${group.variants.length} variants` : ''}</div>
                </div>
              </div>
            `;
            itemsAdded++;
          });
        }
        
        // Show styles from this library
        if (window.unifiedScanData && window.unifiedScanData.stylesByLibrary[lib.name]) {
          const styles = window.unifiedScanData.stylesByLibrary[lib.name];
          
          styles.forEach(style => {
            const styleIcon = style.type === 'Text Style' ? '' : 
                            style.type === 'Color Style' ? '' : 
                            style.type === 'Effect Style' ? '' : '';
            
            html += `
              <div class="component-item">
                <div style="flex: 1;">
                  <div class="component-name">${styleIcon} ${style.name}</div>
                  <div class="component-info">${style.type}</div>
                </div>
              </div>
            `;
            itemsAdded++;
          });
        }
        
        // Show message if no items were added for this library
        if (itemsAdded === 0) {
          html += `<div class="component-item" style="opacity: 0.6;"><div style="flex: 1;"><div class="component-name">No items found</div></div></div>`;
        }
      });
      
      // Add swap all button at the bottom if we have a target library
      if (targetLibrary && swappableLibrary) {
        html += `
          <div class="swap-all-container">
            <button onclick="swapAllUnified('${swappableLibrary.name}', '${targetLibrary}')" 
                    class="swap-all-btn">
               Swap All ${swappableLibrary.name}  ${targetLibrary}
            </button>
          </div>
        `;
      }
      
      unifiedLibraryListEl.innerHTML = html;
      showView('unifiedLibraryView');
    }

    // Open swap modal
    function openSwapModal(componentName, componentKey, sourceLibrary) {
      currentSwapData = {
        componentName: componentName,
        componentKey: componentKey,
        sourceLibrary: sourceLibrary
      };
      
      // Update modal info
      document.getElementById('swapComponentInfo').innerHTML = 
        `<strong>Swap "${componentName}"</strong> from <em>${sourceLibrary}</em> to a different library.<br><br>
        <small><strong>How it works:</strong> This will replace ALL "${componentName}" components from ${sourceLibrary} with the same-named component from your chosen library. For best results, make sure you have at least one "${componentName}" component from each library in your frame before swapping.</small>`;
      
      // Get available libraries (excluding source)
      let availableLibraries = [];
      
      // Add libraries currently in the frame (excluding source)
      const frameLibraries = componentData.libraries.filter(function(lib) {
        return lib.name !== sourceLibrary;
      });
      
      // Add connected libraries
      if (connectedLibraries) {
          connectedLibraries.forEach(function(lib) {
            if (lib.name !== sourceLibrary) {
              const existsInFrame = frameLibraries.some(function(fl) {
                return fl.name === lib.name;
              });
              
              if (!existsInFrame) {
                availableLibraries.push({
                  name: lib.name,
                  count: 0,
                  source: 'configured'
                });
              }
            }
          });
      }
      
      // Add frame libraries
      frameLibraries.forEach(function(lib) {
        availableLibraries.push({
          name: lib.name,
          count: lib.count,
          source: 'frame'
        });
      });
      
      // Populate target library list
      const targetListEl = document.getElementById('targetLibraryList');
      let html = '';
      
      if (availableLibraries.length === 0) {
        html = '<div class="no-items">No other libraries available for swapping</div>';
      } else {
        availableLibraries.forEach(function(lib) {
          let hasMatchingComponent = false;
          let statusText = '';
          
          if (lib.source === 'frame') {
            hasMatchingComponent = componentData.componentsByLibrary[lib.name] && 
              componentData.componentsByLibrary[lib.name].some(function(comp) {
                return comp.name === componentName;
              });
            statusText = hasMatchingComponent ? '  Ready to swap' : '  Ready to swap';
          } else {
            hasMatchingComponent = true;
            statusText = '  Ready to swap';
          }
          
          const disabledClass = '';
          const countText = lib.source === 'frame' ? `${lib.count} components in frame` : 'Library configured';
          
          // Find thumbnail from connectedLibraries
          const connectedLib = connectedLibraries.find(l => l.name === lib.name);
          let iconHtml = `
            <div style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--figma-color-bg-secondary); border-radius: 4px; flex-shrink: 0;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="var(--figma-color-icon)" stroke-width="1.5" stroke-linejoin="round"/>
                <path d="M2 17L12 22L22 17" stroke="var(--figma-color-icon)" stroke-width="1.5" stroke-linejoin="round"/>
                <path d="M2 12L12 17L22 12" stroke="var(--figma-color-icon)" stroke-width="1.5" stroke-linejoin="round"/>
              </svg>
            </div>
          `;
          
          if (connectedLib && connectedLib.thumbnail) {
              iconHtml = `<img src="${connectedLib.thumbnail}" style="width: 32px; height: 32px; border-radius: 4px; object-fit: cover; background: var(--figma-color-bg-secondary); flex-shrink: 0;">`;
          }

          html += `
            <div class="target-library-item${disabledClass}" data-library="${lib.name}" data-has-match="${hasMatchingComponent}" data-source="${lib.source}" style="display: flex; align-items: center; gap: 12px;">
              ${iconHtml}
              <div style="flex: 1;">
                <div class="target-library-name">${lib.name}${statusText}</div>
                <div style="font-size: 11px; color: var(--figma-color-text-secondary);">${countText}</div>
              </div>
            </div>
          `;
        });
      }
      
      targetListEl.innerHTML = html;
      
      // Add click handlers to library items
      document.querySelectorAll('.target-library-item:not(.disabled)').forEach(item => {
        item.addEventListener('click', () => {
          document.querySelectorAll('.target-library-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
        });
      });
      
      // Add click handlers for disabled items to show help
      document.querySelectorAll('.target-library-item.disabled').forEach(item => {
        item.addEventListener('click', () => {
          const libraryName = item.getAttribute('data-library');
          alert(`To enable swapping to ${libraryName}:\n\n1. Open Assets panel in Figma\n2. Find "${componentName}" in the ${libraryName} library\n3. Drag one instance into your frame\n4. Scan frame again\n\nThen you can swap between ${sourceLibrary} and ${libraryName} versions of "${componentName}".`);
        });
      });
      
      // Show modal
      document.getElementById('swapModal').style.display = 'flex';
    }
    
    // Swap all components from one library to another
    function swapAllComponents(sourceLibrary, targetLibrary) {
      if (!componentData || !componentData.componentsByLibrary[sourceLibrary]) {
        alert('No components found to swap');
        return;
      }
      
      const components = componentData.componentsByLibrary[sourceLibrary];
      const componentNames = components.map(comp => comp.name);
      
      if (confirm(`Swap all ${components.length} component${components.length === 1 ? '' : 's'} from ${sourceLibrary} to ${targetLibrary} library?\n\nComponents: ${componentNames.join(', ')}`)) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'SWAP_ALL_COMPONENTS',
            sourceLibrary: sourceLibrary,
            targetLibrary: targetLibrary,
            components: components
          } 
        }, '*');
      }
    }
    
    function closeSwapModal() {
      document.getElementById('swapModal').style.display = 'none';
      currentSwapData = null;
    }
    
    function performSwap() {
      const selectedLibrary = document.querySelector('.target-library-item.selected');
      
      if (!selectedLibrary || !currentSwapData) {
        alert('Please select a target library');
        return;
      }
      
      const targetLibrary = selectedLibrary.getAttribute('data-library');
      const hasMatch = selectedLibrary.getAttribute('data-has-match') === 'true';
      
      if (!hasMatch) {
        alert('Selected library does not have a matching component');
        return;
      }
      
      // Send swap request to plugin
      parent.postMessage({ pluginMessage: {
        type: 'SWAP_COMPONENT',
        sourceComponentName: currentSwapData.componentName,
        sourceComponentKey: currentSwapData.componentKey,
        sourceLibrary: currentSwapData.sourceLibrary,
        targetLibrary: targetLibrary
      }}, '*');
      
      closeSwapModal();
    }

  function performLibrarySwap(data) {
      console.log(' performLibrarySwap called!');
      // Only get mapping items that are NOT the header row
      const mappingItems = document.querySelectorAll('.mapping-item:not(.scan-heading-row)');
      const componentsToSwap = [];
      const stylesToSwap = [];
      console.log('Found mapping items:', mappingItems.length);
      
      // Get the source and target library names from the header labels
      const sourceLibraryLabel = document.getElementById('source-library-label');
      const targetLibraryLabel = document.getElementById('target-library-label');
      console.log('Library label elements:', sourceLibraryLabel, targetLibraryLabel);
      
      if (!sourceLibraryLabel || !targetLibraryLabel) {
        alert('Unable to find source and target library names in header');
        return;
      }
      
      const sourceLibrary = sourceLibraryLabel.textContent?.trim();
      const targetLibrary = targetLibraryLabel.textContent?.trim();
      
      console.log('Extracted source library:', sourceLibrary);
      console.log('Extracted target library:', targetLibrary);
      
      if (!sourceLibrary || !targetLibrary) {
        alert('Unable to determine source and target libraries');
        return;
      }
      
      // Collect all checked items
      // Check components that have checkboxes checked AND are visible (not hidden by search)
      mappingItems.forEach(item => {
        // Skip hidden items (filtered by search)
        if (item.style.display === 'none') {
          return;
        }
        
        const checkbox = item.querySelector('.mapping-checkbox');
        if (checkbox && checkbox.checked) {
          // Check if it's a token (color or typography) or a regular component
          const isColorToken = item.querySelector('.color-swatch') !== null;
          const isTypographyToken = item.querySelector('.text-icon') !== null;
          const isToken = isColorToken || isTypographyToken;
          
          if (isToken) {
            const componentName = item.querySelector('.component-name').textContent;
            stylesToSwap.push({
              name: componentName,
              sourceLibrary: sourceLibrary,
              targetLibrary: targetLibrary
            });
          } else {
            // It's a regular component - use the variant names from data attribute for swapping
            // If multiple variants, they're comma-separated
            const variantNames = item.dataset.variantNames || item.querySelector('.component-name').textContent;
            
            // Get the selected target component name from the dropdown
            const targetNameSpan = item.querySelector('.selected-library-name');
            let selectedTargetName = targetNameSpan ? targetNameSpan.textContent : null;
            
            // Filter out placeholder text
            if (selectedTargetName === 'Select Component' || selectedTargetName === '-') {
                selectedTargetName = null;
            }
            
            // Check for preserve style override setting
            const preserveStyle = item.dataset.preserveStyle === 'true';

            // Get property mapping if configured
            const propertyMapping = (item.scanResult && item.scanResult.propertyMapping) ? item.scanResult.propertyMapping : undefined;
            
            if (propertyMapping) {
                console.log(` [UI] Found property mapping for ${variantNames}:`, propertyMapping);
            } else {
                // debug: check why it might be missing
                // console.log(`[UI] No property mapping found on item for ${variantNames}`, item.scanResult);
            }

            const variants = variantNames.split(',').map(v => v.trim());
            variants.forEach(variantName => {
              componentsToSwap.push({
                name: variantName,
                targetName: selectedTargetName, // Pass the manually selected target name
                sourceLibrary: sourceLibrary,
                targetLibrary: targetLibrary,
                preserveStyle: preserveStyle,
                propertyMapping: propertyMapping
              });
            });
          }
        }
      });
      
      // Styles logic remains unchanged (handled above)
      
      console.log('Components to swap (count):', componentsToSwap.length);
      console.log('Styles to swap (count):', stylesToSwap.length);
      console.log('Source library:', sourceLibrary);
      console.log('Target library:', targetLibrary);
      
      if (componentsToSwap.length === 0 && stylesToSwap.length === 0) {
        alert('No components or styles selected for swapping');
        return;
      }
      
      console.log('Sending PERFORM_LIBRARY_SWAP message...');
      // Send swap request to plugin, now including sourceLibrary and targetLibrary
      parent.postMessage({ pluginMessage: {
        type: 'PERFORM_LIBRARY_SWAP',
        components: componentsToSwap,
        styles: stylesToSwap,
        sourceLibrary: sourceLibrary,
        targetLibrary: targetLibrary
      }}, '*');
    }

    // Unified swap function (components + styles)
    function swapAllUnified(sourceLibrary, targetLibrary) {
      if (!unifiedData) {
        console.log('No data found to swap');
        return;
      }
      
      const components = unifiedData.componentsByLibrary[sourceLibrary] || [];
      const styles = unifiedData.stylesByLibrary[sourceLibrary] || [];
      
      if (components.length === 0 && styles.length === 0) {
        console.log('No components or styles found to swap');
        return;
      }
      
      // Directly execute the swap without confirmation
      parent.postMessage({ 
        pluginMessage: { 
          type: 'SWAP_ALL',
          sourceLibrary: sourceLibrary,
          targetLibrary: targetLibrary,
          components: components,
          styles: styles
        } 
      }, '*');
    }

    // Show detailed view for unified library (placeholder for now)
    function showUnifiedItemsForLibrary(libraryName) {
      alert(`Detailed view for ${libraryName} coming soon! Use "Swap All" for now.`);
    }

    // Make functions global for onclick handlers
    window.showComponentsForLibrary = showComponentsForLibrary;
    window.showUnifiedItemsForLibrary = showUnifiedItemsForLibrary;
    window.swapAllUnified = swapAllUnified;
    window.openSwapModal = openSwapModal;

    // Message handler
    onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      // console.log(' UI Received message:', msg.type, msg);
      
      if (msg.type === 'CURRENT_FILE_STATUS') {
          const { name, isSynced } = msg;
          let message = '';
          
          if (isSynced) {
              message = `Sync all updates to "${name}"?`;
          } else {
              message = `Add "${name}" to list of swappable libraries?`;
          }
          
          if (confirm(message)) {
              parent.postMessage({ pluginMessage: { type: 'SYNC_CURRENT_FILE' } }, '*');
          }
          return;
      }
      
      if (msg.type === 'SHOW_INITIAL_VIEW' || msg.type === 'reset-ui') {
        console.log('Showing initial view - no frame selected');
        showView('scanView');
        // Update the text to indicate frame selection is needed
        const scanTitle = document.querySelector('.scan-title');
        const scanDescription = document.querySelector('.scan-description');
        if (scanTitle) scanTitle.textContent = 'Select a frame to scan';
        if (scanDescription) scanDescription.textContent = 'Select a frame in your design to automatically scan for components and tokens';
        // Optionally clear scan results or other UI state here
        return;
      }

      if (msg.type === 'SHOW_CONNECT_LIBRARY_VIEW') {
        console.log('Showing connect library view - frame selected but no libraries');
        showView('connectLibraryView');
        return;
      }
      
      if (msg.type === 'SCAN_ALL_RESULT') {
        // console.log(' SCAN_ALL_RESULT received');
        if (!msg.ok) {
          const scanView = document.getElementById('scanView');
          let errorDiv = scanView.querySelector('.error');
          if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.style.cssText = 'color: #e74c3c; font-weight: 600; margin-top: 12px; padding: 8px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 4px;';
            scanView.appendChild(errorDiv);
          }
          errorDiv.textContent = msg.error || 'Unknown error';
          return;
        }

        // Clear any previous errors
        const errorDiv = document.getElementById('scanView').querySelector('.error');
        if (errorDiv) errorDiv.remove();

        // Store the scan data
        const scanData = msg.data;
        // console.log('Scan data:', scanData);
        
        // Show library selector view (or skip to results if only one library)
        showLibrarySelector(scanData);
      }

      if (msg.type === 'swap-complete') {
        // Native toast now handled in backend
        console.log('Swap completed:', msg.details);
        return;
      }
    // Removed custom toast logic; now using Figma native toast

      if (msg.type === 'swap-error') {
        alert('Error: ' + (msg.message || 'Swap failed'));
        console.error('Swap error:', msg);
        return;
      }

      if (msg.type === 'SCAN_RESULT') {
        if (!msg.ok) {
          const scanView = document.getElementById('scanView');
          let errorDiv = scanView.querySelector('.error');
          if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.style.cssText = 'color: #e74c3c; font-weight: 600; margin-top: 12px; padding: 8px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 4px;';
            scanView.appendChild(errorDiv);
          }
          errorDiv.textContent = msg.error || 'Unknown error';
          return;
        }

        // Clear any previous errors
        const errorDiv = document.getElementById('scanView').querySelector('.error');
        if (errorDiv) errorDiv.remove();

        componentData = msg.data;
        showLibraries(componentData.libraries);
      }
      
      if (msg.type === 'SWAP_RESULT') {
        if (msg.success) {
          parent.postMessage({ pluginMessage: { type: 'SCAN_FRAME' } }, '*');
        } else {
          console.log('Swap failed:', msg.error || 'Failed to swap component');
        }
      }
      
      if (msg.type === 'SWAP_ALL_RESULT') {
        // Toast notifications are handled by the plugin backend, no need for modal alerts
        console.log('Swap completed:', msg);
      }
      
      if (msg.type === 'KEY_EXTRACTION_RESULT') {
        if (msg.success) {
          console.log('Component Key Extraction Results:');
          console.log('Total components found:', msg.totalComponents);
          console.log('Extracted mapping:', msg.mapping);
          
          // Show a detailed result dialog
          const extractedCount = Object.values(msg.mapping).reduce((sum, lib) => sum + Object.keys(lib).length, 0);
          alert(` Successfully extracted ${extractedCount} component keys!\n\nShark Library: ${Object.keys(msg.mapping.Shark || {}).length} components\nMonkey Library: ${Object.keys(msg.mapping.Monkey || {}).length} components\n\nCheck the browser console (F12) for the complete mapping code that you can copy into your plugin.`);
        } else {
          alert(`Key extraction failed: ${msg.error || 'Unknown error'}\n\nMake sure you have components from both Shark and Monkey libraries in your current document.`);
        }
      }
      
      if (msg.type === 'STYLE_KEY_EXTRACTION_RESULT') {
        if (msg.success) {
          console.log('Style Key Extraction Results:');
          console.log('Total styles found:', msg.totalStyles);
          console.log('Extracted mapping:', msg.mapping);
          
          // Show a detailed result dialog
          const extractedCount = Object.values(msg.mapping).reduce((sum, lib) => sum + Object.keys(lib).length, 0);
          alert(` Successfully extracted ${extractedCount} style keys!\n\nShark Library: ${Object.keys(msg.mapping.Shark || {}).length} styles\nMonkey Library: ${Object.keys(msg.mapping.Monkey || {}).length} styles\n\nCheck the browser console (F12) for the complete style mapping code that you can copy into your plugin.`);
        } else {
          alert(`Style key extraction failed: ${msg.error || 'Unknown error'}\n\nMake sure you have styles from both Shark and Monkey libraries in your current document.`);
        }
      }
      
      if (msg.type === 'STYLE_SCAN_RESULT') {
        if (msg.ok) {
          styleData = msg.data;
          showStyleLibraries(msg.data.libraries);
        } else {
          document.getElementById('scanResult').innerHTML = 
            `<div style="color: red;">Error: ${msg.error}</div>`;
        }
      }
      
      if (msg.type === 'STYLE_SWAP_RESULT') {
        if (msg.success) {
          parent.postMessage({ pluginMessage: { type: 'SCAN_STYLES' } }, '*');
        } else {
          console.log('Style swap failed:', msg.error || 'Failed to swap style');
        }
      }
      
      if (msg.type === 'SWAP_ALL_STYLES_RESULT') {
        if (msg.success) {
          console.log(`Successfully swapped ${msg.totalSwapped} style instances across ${msg.styleCount} style types from ${msg.sourceLibrary} to ${msg.targetLibrary}`);
          // Rescan to update the display
          parent.postMessage({ pluginMessage: { type: 'SCAN_STYLES' } }, '*');
        } else {
          console.log('Style swap completed with errors:', msg);
        }
      }
      


    };

    // Style management functions
    let styleData = null;

    // Show style library list view
    function showStyleLibraries(libraries) {
      const styleLibraryListEl = document.getElementById('styleLibraryList');
      
      if (libraries.length === 0) {
        styleLibraryListEl.innerHTML = '<div class="no-items">No style libraries found in selection</div>';
        showView('styleLibraryView');
        return;
      }

      let html = `<div style="font-weight: 600; margin-bottom: 8px;">Found ${libraries.length} style librar${libraries.length === 1 ? 'y' : 'ies'}:</div>`;
      
      libraries.forEach(lib => {
        // Determine target library for swapping
        let targetLibrary = null;
        if (connectedLibraries && connectedLibraries.length > 0) {
             const otherLib = connectedLibraries.find(l => l.name !== lib.name);
             if (otherLib) {
                 targetLibrary = otherLib.name;
             }
        }
        
        html += `
          <div class="library-item">
            <div onclick="showStylesForLibrary('${lib.name}')" style="flex: 1; cursor: pointer;">
              <div class="library-name">${lib.name}</div>
              <div class="library-count">${lib.count} style${lib.count === 1 ? '' : 's'}</div>
            </div>
            ${targetLibrary ? `
              <button onclick="swapAllStyles('${lib.name}', '${targetLibrary}')" 
                      style="margin-left: 12px; padding: 8px 16px; font-size: 11px; white-space: nowrap; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Swap All  ${targetLibrary}
              </button>
            ` : ''}
          </div>
        `;
      });
      
      styleLibraryListEl.innerHTML = html;
      showView('styleLibraryView');
    }

    // Show styles for a specific library
    function showStylesForLibrary(libraryName) {
      const currentStyleLibraryNameEl = document.getElementById('currentStyleLibraryName');
      const styleListEl = document.getElementById('styleList');
      
      currentStyleLibraryNameEl.textContent = libraryName;
      
      if (!styleData || !styleData.stylesByLibrary[libraryName]) {
        styleListEl.innerHTML = '<div class="no-items">No styles found</div>';
        showView('styleView');
        return;
      }

      const styles = styleData.stylesByLibrary[libraryName];
      
      let html = `<div style="font-weight: 600; margin-bottom: 8px;">${styles.length} style${styles.length === 1 ? '' : 's'}:</div>`;
      
      styles.forEach(style => {
        // Color code by style type
        let borderColor = '#ccc';
        if (style.type === 'Text Style') borderColor = '#2196f3';
        else if (style.type === 'Color Style' || style.type === 'Stroke Style') borderColor = '#ff5722';
        else if (style.type === 'Effect Style') borderColor = '#9c27b0';
        
        html += `
          <div class="component-item" style="border-left: 4px solid ${borderColor};">
            <div class="component-name">${style.name}</div>
            <div class="component-info">Type: ${style.type} | Key: ${style.key.substring(0, 12)}...</div>
          </div>
        `;
      });
      
      styleListEl.innerHTML = html;
      showView('styleView');
    }

    // Swap all styles from one library to another
    function swapAllStyles(sourceLibrary, targetLibrary) {
      if (!styleData || !styleData.stylesByLibrary[sourceLibrary]) {
        alert('No styles found to swap');
        return;
      }
      
      const styles = styleData.stylesByLibrary[sourceLibrary];
      const styleNames = styles.map(style => style.name);
      
      if (confirm(`Swap all ${styles.length} style${styles.length === 1 ? '' : 's'} from ${sourceLibrary} to ${targetLibrary} library?\n\nStyles: ${styleNames.join(', ')}`)) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'SWAP_ALL_STYLES',
            sourceLibrary: sourceLibrary,
            targetLibrary: targetLibrary,
            styles: styles
          } 
        }, '*');
      }
    }

    // Configuration management (simplified) - REMOVED
    /*
    let currentConfigLevel = 'user';

    function showConfigSection(level) {
      currentConfigLevel = level;
      
      document.getElementById('userConfigSection').style.display = 'none';
      document.getElementById('teamConfigSection').style.display = 'none';
      document.getElementById('orgConfigSection').style.display = 'none';
      
      document.querySelectorAll('.config-tab-btn').forEach(btn => btn.classList.remove('active'));
      
      document.getElementById(level + 'ConfigSection').style.display = 'block';
      document.getElementById('show' + level.charAt(0).toUpperCase() + level.slice(1) + 'ConfigBtn').classList.add('active');
    }
    */

    // DEBUG: Dump Storage
    function debugDumpStorage() {
      parent.postMessage({ pluginMessage: { type: 'DEBUG_DUMP_STORAGE' } }, '*');
    }

    // Search logic function - MUST be global scope for access from multiple places
    function applySearchLogic(searchTerm) {
      const mappingItems = document.querySelectorAll('.mapping-item:not(.scan-heading-row)');
      const noSearchResults = document.getElementById('noSearchResults');
      const headingRow = document.querySelector('.scan-heading-row');
      let hasVisibleItems = false;
      
      console.log('Search logic:', { searchTerm: searchTerm, itemCount: mappingItems.length });
      
      mappingItems.forEach(item => {
        const componentNames = item.querySelectorAll('.component-name');
        let itemMatches = false;
        
        // Check if any component name in this row matches the search term
        componentNames.forEach(nameElement => {
          const name = nameElement.textContent.toLowerCase();
          if (name.includes(searchTerm)) {
            itemMatches = true;
          }
        });
        
        // Mark item as search-hidden or search-visible using data attribute
        if (searchTerm === '' || itemMatches) {
          item.dataset.searchHidden = 'false';
          hasVisibleItems = true;
        } else {
          item.dataset.searchHidden = 'true';
        }
      });
      
      // Show or hide the empty state message and heading labels
      const showEmpty = !hasVisibleItems;
      if (noSearchResults) {
        noSearchResults.style.display = showEmpty ? '' : 'none';
      }
      if (headingRow) {
        headingRow.style.display = showEmpty ? 'none' : '';
      }
      
      // Also apply filter logic to respect both search AND filter state
      applyFilterLogic();
    }

    // Filter logic function - MUST be global scope for access from multiple places
    function applyFilterLogic() {
      const mappingItems = document.querySelectorAll('.mapping-item:not(.scan-heading-row)');
      const filterCheckboxes = document.querySelectorAll('.filter-option');
      const selectedFilters = Array.from(filterCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
      
      console.log('Filter state:', {
        checkboxes: Array.from(filterCheckboxes).map(cb => ({ value: cb.value, checked: cb.checked })),
        selectedFilters: selectedFilters,
        itemCount: mappingItems.length
      });
      
      // If no filters are selected, show all items
      if (selectedFilters.length === 0) {
        mappingItems.forEach(item => {
          const isSearchHidden = item.dataset.searchHidden === 'true';
          item.style.display = isSearchHidden ? 'none' : '';
        });
      } else {
        let hasVisibleItems = false;
        
        mappingItems.forEach(item => {
          // Check if item is hidden by search
          const isSearchHidden = item.dataset.searchHidden === 'true';
          
          // Determine item type
          let itemType = 'component';
          const hasColorSwatch = item.querySelector('.color-swatch') !== null;
          const hasTextIcon = item.querySelector('.text-icon') !== null;
          
          if (hasColorSwatch) {
            itemType = 'color';
          } else if (hasTextIcon) {
            itemType = 'typography';
          } else {
            itemType = 'component';
          }
          
          // Check if this item type is selected in the filter
          const passesFilter = selectedFilters.includes(itemType);
          
          // Item is visible only if it passes both search AND filter
          const shouldShow = !isSearchHidden && passesFilter;
          
          if (shouldShow) {
            item.style.display = '';
            hasVisibleItems = true;
          } else {
            item.style.display = 'none';
          }
        });
        
        // Show empty state if no visible items
        const noSearchResults = document.getElementById('noSearchResults');
        const headingRow = document.querySelector('.scan-heading-row');
        if (noSearchResults) {
          noSearchResults.style.display = hasVisibleItems ? 'none' : '';
        }
        if (headingRow) {
          headingRow.style.display = hasVisibleItems ? '' : 'none';
        }
      }
    }

    // Event listeners - wrapped in function to ensure DOM is ready
    function initializeEventListeners() {
      // Main navigation
      const scanAllBtn = document.getElementById('scanAllBtn');
      
      if (scanAllBtn) {
        scanAllBtn.addEventListener('click', () => {
          console.log('Scan button clicked!');
          parent.postMessage({ pluginMessage: { type: 'SCAN_ALL' } }, '*');
          console.log('Message sent to plugin');
        });
      }

      // Settings screen event listeners
      const settingsExportBtn = document.getElementById('settingsExportBtn');

      if (settingsExportBtn) {
        settingsExportBtn.addEventListener('click', () => {
          parent.postMessage({ pluginMessage: { type: 'UPDATE_LIBRARY_DEFINITIONS' } }, '*');
        });
      }



    // Back navigation event listeners with defensive checks
    const backElements = [
      { id: 'backToScan', view: 'scanView' },
      { id: 'backToScanFromConfig', view: 'scanView' },
      { id: 'backToLibraries', view: 'librarySelectorView' },
      { id: 'backToScanFromLibraries', view: 'scanView' },
      { id: 'backToScanFromComponents', view: 'scanView' },
      { id: 'backToScanFromStyleLibraries', view: 'scanView' },
      { id: 'backToScanFromStyleLibrariesBtn', view: 'scanView' },
      { id: 'backToStyleLibraries', view: 'styleLibraryView' },
      { id: 'backToScanFromStyles', view: 'scanView' },
      { id: 'backToScanFromUnified', view: 'scanView' },
      { id: 'backFromSelectorBtn', view: 'scanView' }
    ];

    backElements.forEach(({ id, view }) => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('click', () => {
          showView(view);
        });
      }
    });

    // Use setTimeout to ensure DOM is ready
    setTimeout(() => {
      const backToScanFromSettingsBtn = document.getElementById('backToScanFromSettings');
      if (backToScanFromSettingsBtn) {
        backToScanFromSettingsBtn.addEventListener('click', () => {
          // console.log('Back to scan from settings clicked');
          showView('scanView');
        });
        // console.log('Settings back button event listener added successfully');
      } else {
        console.error('backToScanFromSettings button not found');
      }
    }, 100);

    /*
    document.getElementById('showUserConfigBtn').addEventListener('click', () => {
      showConfigSection('user');
    });

    document.getElementById('showTeamConfigBtn').addEventListener('click', () => {
      showConfigSection('team');
    });

    document.getElementById('showOrgConfigBtn').addEventListener('click', () => {
      showConfigSection('org');
    });
    */

    // Sync Current File Button
    const syncCurrentFileBtn = document.getElementById('syncCurrentFileBtn');
    if (syncCurrentFileBtn) {
        syncCurrentFileBtn.addEventListener('click', () => {
            parent.postMessage({ pluginMessage: { type: 'CHECK_CURRENT_FILE_STATUS' } }, '*');
        });
    }

    // Clear All Button
    const clearAllBtn = document.getElementById('clearAllBtn');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all connected libraries?')) {
                parent.postMessage({ pluginMessage: { type: 'CLEAR_LIBRARIES' } }, '*');
            }
        });
    }

    // Swap modal event listeners
    document.getElementById('cancelSwapBtn').addEventListener('click', () => {
      closeSwapModal();
    });

    document.getElementById('confirmSwapBtn').addEventListener('click', () => {
      performSwap();
    });

    // Main swap button event listener
    document.getElementById('swapLibraryBtn').addEventListener('click', () => {
      if (!unifiedData || !unifiedData.components) {
        alert('No scan results available. Please scan a frame before swapping.');
        return;
      }
      performLibrarySwap(unifiedData);
    });

    // Search functionality
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        applySearchLogic(searchTerm);
      });
    }

    // Filter button - open on click, close on click again
    const filterBtn = document.getElementById('filterBtn');
    const filterDropdown = document.getElementById('filterDropdown');
    const filterDropdownOverlay = document.getElementById('filterDropdownOverlay');
    
    if (filterBtn && filterDropdown && filterDropdownOverlay) {
      filterBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent event from bubbling to document click handler
        
        // Toggle display
        if (filterDropdown.style.display === '') {
          filterDropdown.style.display = 'none';
          filterDropdownOverlay.classList.remove('active');
          filterBtn.classList.remove('active');
          filterBtn.blur();
        } else {
          filterDropdown.style.display = '';
          filterDropdownOverlay.classList.add('active');
          filterBtn.classList.add('active');
        }
      });
      
      // Overlay click closes dropdown
      filterDropdownOverlay.addEventListener('click', (e) => {
        e.stopPropagation();
        filterDropdown.style.display = 'none';
        filterDropdownOverlay.classList.remove('active');
        filterBtn.classList.remove('active');
        filterBtn.blur();
      });
    }

    // Filter checkboxes logic
    const filterCheckboxes = document.querySelectorAll('.filter-option');
    filterCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        applyFilterLogic();
      });
    });

    // Close filter dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (filterDropdown && filterBtn && filterDropdownOverlay && !filterBtn.contains(e.target) && !filterDropdown.contains(e.target)) {
        filterDropdown.style.display = 'none';
        filterDropdownOverlay.classList.remove('active');
        filterBtn.classList.remove('active');
        filterBtn.blur();
      }
    });

    // Toggle checkbox when clicking on mapping item row (using event delegation)
    document.addEventListener('click', (e) => {
      // Find the closest mapping-item that isn't the header
      const mappingItem = e.target.closest('.mapping-item:not(.scan-heading-row)');
      if (!mappingItem) return;
      
      // Don't toggle if clicking on the checkbox itself
      if (e.target.classList.contains('mapping-checkbox')) {
        return;
      }
      
      // Find the checkbox in this row and toggle it
      const checkbox = mappingItem.querySelector('.mapping-checkbox');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        // Trigger change event so swap logic updates
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
    
    // Close the initialize function
    }
    
    // --- Settings View Logic ---

    // State for connected libraries (mocked initially, will be updated from backend)
    let connectedLibraries = [];
    
    let libraryToRemove = null;

    function renderConnectedLibraries() {
      const listContainer = document.getElementById('connectedLibrariesList');
      if (!listContainer) return;
      
      listContainer.innerHTML = '';
      
      if (connectedLibraries.length === 0) {
        listContainer.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--figma-color-text-secondary); font-size: 11px;">No libraries connected</div>';
        return;
      }
      
      connectedLibraries.forEach(lib => {
        const item = document.createElement('div');
        item.className = 'library-selector-item'; // Use same class as Connected Libraries screen
        item.style.cursor = 'default'; // Override pointer cursor
        item.dataset.id = lib.id;
        
        // Thumbnail logic
        const thumbnail = lib.thumbnail;
        const thumbStyle = thumbnail 
            ? `background-image: url('${thumbnail}'); background-size: cover; background-position: center;` 
            : `background: var(--figma-color-bg-secondary); display: flex; align-items: center; justify-content: center;`;
            
        const thumbContent = thumbnail 
            ? '' 
            : `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="var(--figma-color-icon-secondary)" stroke-width="1.5" stroke-linejoin="round"/><path d="M2 17L12 22L22 17" stroke="var(--figma-color-icon-secondary)" stroke-width="1.5" stroke-linejoin="round"/><path d="M2 12L12 17L22 12" stroke="var(--figma-color-icon-secondary)" stroke-width="1.5" stroke-linejoin="round"/></svg>`;

        item.innerHTML = `
          <div class="library-selector-thumbnail" style="${thumbStyle}">${thumbContent}</div>
          <div class="library-selector-info">
            <div class="library-selector-name">${lib.name}</div>
            <div class="library-selector-count">${lib.type || 'Remote'}  ${lib.key ? 'Connected' : 'Local'}</div>
          </div>
          <div class="library-selector-arrow">
            <button class="library-more-btn filter-button">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.5 12C7.5 12.8284 6.82843 13.5 6 13.5C5.17157 13.5 4.5 12.8284 4.5 12C4.5 11.1716 5.17157 10.5 6 10.5C6.82843 10.5 7.5 11.1716 7.5 12Z" fill="currentColor" fill-opacity="0.9"/>
                <path d="M13.5 12C13.5 12.8284 12.8284 13.5 12 13.5C11.1716 13.5 10.5 12.8284 10.5 12C10.5 11.1716 11.1716 10.5 12 10.5C12.8284 10.5 13.5 11.1716 13.5 12Z" fill="currentColor" fill-opacity="0.9"/>
                <path d="M18 13.5C18.8284 13.5 19.5 12.8284 19.5 12C19.5 11.1716 18.8284 10.5 18 10.5C17.1716 10.5 16.5 11.1716 16.5 12C16.5 12.8284 17.1716 13.5 18 13.5Z" fill="currentColor" fill-opacity="0.9"/>
              </svg>
            </button>
          </div>
        `;
        
        // Context menu handler
        const moreBtn = item.querySelector('.library-more-btn');
        moreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showLibraryContextMenu(e, lib);
        });
        
        listContainer.appendChild(item);
      });
    }

    // Access Token functions removed


    function showLibraryContextMenu(e, lib) {
      const menu = document.getElementById('libraryContextMenu');
      if (!menu) return;
      
      // Add active state to button
      const btn = e.currentTarget;
      if (btn && btn.classList.contains('filter-button')) {
        btn.classList.add('active');
      }

      libraryToRemove = lib;
      
      // Position menu
      const rect = btn.getBoundingClientRect();
      menu.style.top = `${rect.bottom + window.scrollY + 4}px`;
      menu.style.left = `${rect.right - 224}px`; // Align right edge
      menu.style.display = 'block';
      
      // Close on click outside
      const closeMenu = () => {
        menu.style.display = 'none';
        if (btn) btn.classList.remove('active');
        document.removeEventListener('click', closeMenu);
      };
      
      // Delay slightly to avoid immediate close from the click that opened it
      setTimeout(() => {
        document.addEventListener('click', closeMenu);
      }, 0);
    }

    let scanResultToModify = null;
    let scanResultMappingItem = null;
    let currentActiveMenuButton = null;
    let currentOverlayCloser = null;

    function closeScanResultContextMenu() {
        const menu = document.getElementById('scanResultContextMenu');
        const overlay = document.getElementById('filterDropdownOverlay');
        if (menu) menu.style.display = 'none';
        
        if (overlay) {
             overlay.classList.remove('active');
             if (currentOverlayCloser) {
                 overlay.removeEventListener('click', currentOverlayCloser);
                 currentOverlayCloser = null;
             }
        }
        
        if (currentActiveMenuButton) {
            currentActiveMenuButton.classList.remove('active');
            currentActiveMenuButton = null;
        }
    }

    function showScanResultContextMenu(e, result) {
      const menu = document.getElementById('scanResultContextMenu');
      const overlay = document.getElementById('filterDropdownOverlay');
      if (!menu) return;
      
      // Prevent clicks inside the menu from bubbling up to document/overlay
      // We only need to add this once, but adding it repeatedly is safe if we check
      if (!menu.dataset.hasStopListener) {
          menu.addEventListener('click', (ev) => ev.stopPropagation());
          menu.dataset.hasStopListener = 'true';
      }
      
      const btn = e.currentTarget;
      
      // Robust Toggle Logic:
      // If the menu is currently OPEN (display: block) AND the active button is THIS button
      // Then we want to CLOSE it.
      if (menu.style.display === 'block' && currentActiveMenuButton === btn) {
          closeScanResultContextMenu();
          return;
      }
      
      // Otherwise, we are opening it (either from closed state, or switching from another button)
      // First, ensure any existing menu/state is closed cleanly
      closeScanResultContextMenu();
      
      // Now Open for new button
      if (btn && btn.classList.contains('filter-button')) {
        btn.classList.add('active');
        currentActiveMenuButton = btn;
      }

      scanResultToModify = result;
      scanResultMappingItem = btn.closest('.mapping-item');
      
      // Initialize menu state based on mapping item
      if (scanResultMappingItem) {
          const preserveBtn = document.getElementById('preserveStyleBtn');
          const isPreserved = scanResultMappingItem.dataset.preserveStyle === 'true';
          if (preserveBtn) {
              if (isPreserved) preserveBtn.classList.add('checked');
              else preserveBtn.classList.remove('checked');
              
              preserveBtn.onclick = (evt) => {
                  evt.stopPropagation(); 
                  const newState = !preserveBtn.classList.contains('checked');
                  if (newState) {
                      preserveBtn.classList.add('checked');
                      scanResultMappingItem.dataset.preserveStyle = 'true';
                  } else {
                      preserveBtn.classList.remove('checked');
                      scanResultMappingItem.dataset.preserveStyle = 'false';
                  }
                  // We do NOT close the menu here, allowing multiple toggles if needed.
                  // If desired to close, uncomment line below:
                  // closeScanResultContextMenu();
              };
          }
          
          const configureBtn = document.getElementById('configurePropsBtn');
          if (configureBtn) {
              configureBtn.onclick = (evt) => {
                  console.log('Configure properties clicked');
                  evt.stopPropagation();
                  closeScanResultContextMenu();
                  
                  if (scanResultToModify) {
                      console.log('Result obj:', scanResultToModify);
                      const candidate = scanResultToModify.bestCandidate;
                      
                      if (candidate) {
                         console.log('Found candidate:', candidate);
                         const targetKey = candidate.key;
                         const targetName = candidate.name;
                         
                         parent.postMessage({ 
                            pluginMessage: { 
                                type: 'GET_COMPONENT_PROPERTIES',
                                // Prefer the instance ID if available to get actual override values
                                sourceId: scanResultToModify.instanceId || scanResultToModify.id || (scanResultToModify.variants && scanResultToModify.variants[0].id),
                                targetKey: targetKey,
                                targetName: targetName,
                                targetLibraryName: candidate.libraryName,
                                sourceLibraryName: scanResultToModify.library
                            } 
                         }, '*');
                      } else {
                          console.log("No target candidate found for configuration. Scan result:", scanResultToModify);
                          // Fallback: Check if we can get it from the UI dropdown? 
                          // (Not implemented yet, but helpful for debug)
                      }
                  } else {
                      console.error('No scanResultToModify found');
                  }
              }
          }
      }
      
      // Position menu
      const rect = btn.getBoundingClientRect();
      menu.style.top = `${rect.bottom + window.scrollY + 4}px`;
      menu.style.left = `${rect.right - 208 - 16}px`; 
      menu.style.display = 'block';
      
      if (overlay) {
        overlay.classList.add('active');
        // Add one-time listener to close
        const overlayCloser = (ev) => {
             // Ensure we don't close if the click was actually on the menu (though z-index should prevent this hitting overlay)
             // or on the button itself (which has its own handler)
             // But valid usage of overlay is clicking "elsewhere".
             ev.stopPropagation();
             closeScanResultContextMenu();
        };
        overlay.addEventListener('click', overlayCloser);
        currentOverlayCloser = overlayCloser;
      } else {
        // Fallback for no overlay
        setTimeout(() => {
          const docCloser = (ev) => {
              if (menu.contains(ev.target)) return;
              if (btn && btn.contains(ev.target)) return; // Let toggle logic handle it
              closeScanResultContextMenu();
              document.removeEventListener('click', docCloser);
          };
          document.addEventListener('click', docCloser);
        }, 0);
      }
    }

    function showComponentSelectionMenu(e, targetLibObj, mappingItem, sourceVariant) {
      const menu = document.getElementById('componentSelectionMenu');
      const overlay = document.getElementById('filterDropdownOverlay');
      if (!menu || !targetLibObj || !targetLibObj.components) return;
      
      const trigger = e.currentTarget;
      trigger.classList.add('active');
      
      // Populate menu
      menu.innerHTML = '';
      const components = Object.keys(targetLibObj.components).sort();
      
      if (components.length === 0) {
          menu.innerHTML = '<div class="dropdown-option" style="padding: 8px; color: var(--figma-color-text-secondary); font-style: italic; cursor: default;">No components found</div>';
      } else {
          components.forEach(compName => {
              const item = document.createElement('div');
              item.className = 'dropdown-option';
              
              const nameSpan = mappingItem.querySelector('.selected-library-name');
              const currentName = nameSpan ? nameSpan.textContent : '';
              if (compName === currentName) {
                  item.classList.add('selected');
              }
              
              const checkIcon = `<svg class="dropdown-check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.7773 4.084C12.0071 4.23717 12.0692 4.54761 11.916 4.77737L7.91603 10.7774C7.83293 10.902 7.69834 10.9828 7.54927 10.9976C7.4002 11.0123 7.25237 10.9595 7.14645 10.8536L4.14645 7.85358C3.95118 7.65831 3.95118 7.34173 4.14645 7.14647C4.34171 6.95121 4.65829 6.95121 4.85355 7.14647L7.42229 9.7152L11.084 4.22267C11.2372 3.99291 11.5476 3.93082 11.7773 4.084Z" fill="currentColor" fill-opacity="0.9"/></svg>`;
              
              const componentIcon = `<div class="icon-container" style="width: 16px; height: 16px; margin-right: 8px; display: inline-flex; align-items: center; justify-content: center;"><svg class="component-icon" viewBox="0 0 24 24" fill="none" style="width: 16px; height: 16px;"><path d="M11.1163 13.5907C11.6045 13.1027 12.3958 13.1026 12.8839 13.5907L14.2628 14.9696C14.7506 15.4577 14.7507 16.2491 14.2628 16.7372L12.8839 18.1161C12.3958 18.604 11.6045 18.6039 11.1163 18.1161L9.73741 16.7372C9.24928 16.249 9.24935 15.4577 9.73741 14.9696L11.1163 13.5907ZM12.1769 14.2977C12.0793 14.2001 11.921 14.2002 11.8233 14.2977L10.4444 15.6766C10.3469 15.7743 10.3468 15.9325 10.4444 16.0301L11.8233 17.409C11.921 17.5064 12.0793 17.5065 12.1769 17.409L13.5558 16.0301C13.6531 15.9326 13.6531 15.7742 13.5558 15.6766L12.1769 14.2977ZM7.2628 9.73716C7.75097 9.24916 8.54227 9.24906 9.03038 9.73716L10.4093 11.1161C10.8972 11.6042 10.8972 12.3956 10.4093 12.8836L9.03038 14.2626C8.54229 14.7505 7.75094 14.7504 7.2628 14.2626L5.88389 12.8836C5.39577 12.3955 5.39583 11.6042 5.88389 11.1161L7.2628 9.73716ZM14.9698 9.73716C15.458 9.2491 16.2493 9.24904 16.7374 9.73716L18.1163 11.1161C18.6042 11.6042 18.6043 12.3956 18.1163 12.8836L16.7374 14.2626C16.2493 14.7506 15.458 14.7504 14.9698 14.2626L13.5909 12.8836C13.1028 12.3955 13.1028 11.6042 13.5909 11.1161L14.9698 9.73716ZM8.32334 10.4442C8.22576 10.3466 8.06747 10.3467 7.96983 10.4442L6.59092 11.8231C6.49339 11.9207 6.49332 12.0789 6.59092 12.1766L7.96983 13.5555C8.06778 13.6529 8.22613 13.6529 8.32367 13.5554L9.70257 12.1765C9.80001 12.079 9.79989 11.9206 9.70257 11.823L8.32367 10.4441ZM16.0307 10.4441C15.9331 10.3465 15.7748 10.3466 15.6772 10.4441L14.2983 11.823C14.2007 11.9207 14.2007 12.0789 14.2983 12.1765L15.6772 13.5554C15.7748 13.6527 15.9331 13.6529 16.0307 13.5554L17.4096 12.1765C17.507 12.079 17.5069 11.9206 17.4096 11.823L16.0307 10.4441ZM11.1166 5.88364C11.6048 5.39559 12.3961 5.39553 12.8842 5.88364L14.2631 7.26253C14.7509 7.75067 14.7511 8.54203 14.2631 9.03009L12.8842 10.409L12.7895 10.4949C12.3313 10.8686 11.6696 10.8684 11.2114 10.4949L11.1166 10.409L9.73773 9.03009C9.2801 8.57247 9.2514 7.84822 9.65179 7.35726L9.73773 7.26253L11.1166 5.88364ZM12.1772 6.59067C12.0796 6.49307 11.9213 6.49313 11.8237 6.59067L10.4444 7.96955C10.3472 8.06719 10.3472 8.22547 10.4448 8.32307L11.8237 9.70195C11.921 9.79927 12.0796 9.7994 12.1772 9.70195L13.5561 8.32307C13.6535 8.22552 13.6534 8.06718 13.5561 7.96955L12.1772 6.59067Z" fill="currentColor"/></svg></div>`;
              
              item.innerHTML = `${checkIcon}${componentIcon}<span>${compName}</span>`;
              
              item.onclick = (e) => {
                  e.stopPropagation();
                  // Update UI
                  if (nameSpan) {
                      nameSpan.textContent = compName;
                      nameSpan.style.color = '';
                      nameSpan.style.fontStyle = '';
                  }
                  
                  // Update Data Model
                  if (mappingItem.scanResult && targetLibObj.components[compName]) {
                      const newKey = targetLibObj.components[compName];
                      // Update or Create bestCandidate
                      mappingItem.scanResult.bestCandidate = {
                          name: compName,
                          key: newKey,
                          libraryName: targetLibObj.name
                      };
                      
                      // Clear explicit property mappings as component changed (to trigger fresh auto-match)
                      mappingItem.scanResult.propertyMapping = {};
                      
                      console.log('Updated target component to:', compName, newKey);
                  }

                  // Close menu
                  closeMenu();
              };
              
              menu.appendChild(item);
          });
      }
      
      // Position menu
      const rect = trigger.getBoundingClientRect();
      menu.style.top = `${rect.bottom + window.scrollY + 4}px`;
      menu.style.left = `${rect.left}px`;
      menu.style.width = 'auto';
      menu.style.minWidth = `${Math.max(rect.width, 254)}px`;
      menu.style.display = 'block';
      
      // Close logic
      const closeMenu = () => {
        menu.style.display = 'none';
        trigger.classList.remove('active');
        if (overlay) {
          overlay.classList.remove('active');
          overlay.removeEventListener('click', closeMenu);
        } else {
          document.removeEventListener('click', closeMenu);
        }
      };
      
      if (overlay) {
        overlay.classList.add('active');
        overlay.addEventListener('click', closeMenu);
      } else {
        setTimeout(() => {
          document.addEventListener('click', closeMenu);
        }, 0);
      }
    }

    function handleRemoveLibrary(e) {
      if (e) {
        e.stopPropagation();
      }
      if (libraryToRemove) {
        if (confirm(`Remove library "${libraryToRemove.name}"?`)) {
          // Send to backend
          parent.postMessage({ pluginMessage: { type: 'REMOVE_LIBRARY', libraryId: libraryToRemove.id } }, '*');
          
          // Optimistically remove
          connectedLibraries = connectedLibraries.filter(l => l.id !== libraryToRemove.id);
          renderConnectedLibraries();
        }
      }
      document.getElementById('libraryContextMenu').style.display = 'none';
    }

    function initializeSettingsLogic() {
      // Remove Library Button (Context Menu)
      const removeBtn = document.getElementById('removeLibraryBtn');
      if (removeBtn) {
        removeBtn.addEventListener('click', handleRemoveLibrary);
      }
      
      // Hook into settings button to refresh list
      const settingsBtn = document.getElementById('settingsBtn');
      if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
          showView('settingsView');
          renderConnectedLibraries();
        });
      }

      // Hook into settings button from connect view
      const settingsBtnFromConnect = document.getElementById('settingsBtnFromConnect');
      if (settingsBtnFromConnect) {
        settingsBtnFromConnect.addEventListener('click', () => {
          showView('settingsView');
          renderConnectedLibraries();
        });
      }
      
      // Initial render
      renderConnectedLibraries();
      
      // Fetch from backend
      // console.log(' Requesting connected libraries from backend...');
      parent.postMessage({ pluginMessage: { type: 'GET_CONNECTED_LIBRARIES' } }, '*');
    }
    
    // Extend onmessage to handle library updates
    const originalOnMessage = onmessage;
    onmessage = (event) => {
      if (originalOnMessage) originalOnMessage(event);
      
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      if (msg.type === 'LIBRARIES_UPDATED') {
        // console.log(' UI received LIBRARIES_UPDATED:', msg.libraries);
        connectedLibraries = msg.libraries;
        renderConnectedLibraries();
        
        // If we have scan results visible, re-render them to update target names
        if (window.unifiedScanData && document.getElementById('scanResultsView').classList.contains('active')) {
             // Pass the currently selected source library if available
             updateScanResultsView(window.unifiedScanData, window.selectedSourceLibrary);
        }

        // Automatically dismiss "Connect library" screen if libraries are now connected
        const connectLibraryView = document.getElementById('connectLibraryView');
        if (connectLibraryView && connectLibraryView.classList.contains('active') && connectedLibraries.length > 0) {
            showView('scanView');
            // Automatically trigger scan if we have a frame selected
            parent.postMessage({ pluginMessage: { type: 'SCAN_ALL' } }, '*');
        }
      }
      
      if (msg.type === 'ACCESS_TOKEN_LOADED') {
        // Token logic removed
      }
    };

    // Call init
    initializeSettingsLogic();
    
    // Initialize all event listeners when DOM is ready
    initializeEventListeners();
    
    //# sourceURL=ui.js
  </script>
</body>
</html>
  <script>
    // --- PROPERTY MAPPING LOGIC EXTENSION ---
    
    let currentPropMappingTrigger = null;

    const prevOnMessage = onmessage;
    onmessage = (event) => {
        if (prevOnMessage) prevOnMessage(event);
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === 'SHOW_PROPERTY_MAPPING_VIEW') {
            renderPropertyMappingView(msg.sourceId, msg.targetName, msg.sourceDefinitions, msg.targetDefinitions, msg.targetLibraryName, msg.sourceLibraryName, msg.sourceComponentName, msg.sourcePropertyValues);
        }
    };

    function renderPropertyMappingView(sourceId, targetName, sourceDefs, targetDefs, targetLibraryName, sourceLibraryName, sourceComponentName, sourcePropertyValues) {
        showView('propertyMappingView');
        
        const titleEl = document.getElementById('propMappingComponentName');
        if (titleEl) titleEl.textContent = targetName || 'Component';

        const badgeEl = document.getElementById('propMappingLibraryName');
        if (badgeEl) badgeEl.textContent = targetLibraryName || 'Library';
        
        const list = document.getElementById('propertyMappingList');
        if (list) {
            list.innerHTML = '';
            
            if (!targetDefs || Object.keys(targetDefs).length === 0) {
                list.innerHTML = '<div style="padding:16px; color: var(--figma-color-text-secondary);">No configurable properties found on target component.</div>';
                return;
            }

            // Group target definitions by type
            const groups = {
                'VARIANT': [],
                'BOOLEAN': [],
                'TEXT': [],
                'INSTANCE_SWAP': []
            };
            const other = [];

            Object.entries(targetDefs).forEach(([propName, def]) => {
                if (propName.startsWith('__')) return;
                
                if (Object.prototype.hasOwnProperty.call(groups, def.type)) {
                    groups[def.type].push({ propName, def });
                } else {
                    other.push({ propName, def });
                }
            });

            // Helper to render a group
            const renderGroup = (label, items) => {
                if (items.length === 0) return;

                // Section Header - REMOVED
                /*
                const sectionHeader = document.createElement('div');
                sectionHeader.style.fontSize = '11px';
                sectionHeader.style.fontWeight = '600';
                sectionHeader.style.color = 'var(--figma-color-text-secondary)';
                sectionHeader.style.backgroundColor = 'var(--figma-color-bg-tertiary)';
                sectionHeader.style.padding = '8px 12px';
                sectionHeader.style.marginTop = '4px';
                sectionHeader.style.marginBottom = '4px';
                sectionHeader.style.textTransform = 'uppercase';
                sectionHeader.style.letterSpacing = '0.5px';
                sectionHeader.textContent = label;
                list.appendChild(sectionHeader);
                */

                // Sort items by name within group
                items.sort((a, b) => a.propName.split('#')[0].localeCompare(b.propName.split('#')[0]));

                items.forEach(({ propName, def }) => {
                    const cleanTargetName = propName.split('#')[0];

                    const row = document.createElement('div');
                    row.className = 'prop-mapping-row';
                    
                    // Left Column: Target Property (Library)
                    const leftCol = document.createElement('div');
                    leftCol.className = 'prop-source-col';
                    
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'prop-icon';
                    iconDiv.innerHTML = getPropIcon(def.type);
                    
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'prop-label';
                    labelDiv.textContent = cleanTargetName;
                    labelDiv.title = propName;
                    
                    leftCol.appendChild(iconDiv);
                    leftCol.appendChild(labelDiv);
                    
                    // Right Column: Dropdown (Source Local Props)
                    const rightCol = document.createElement('div');
                    rightCol.className = 'prop-target-col';
                    
                    const dropdown = document.createElement('div');
                    dropdown.className = 'prop-dropdown';
                    
                    // Default: Find matching name
                    let selectedPropRaw = null;
                    let selectedPropDisplay = 'No mapping';

                    // CHECK PERSISTENCE FIRST:
                    if (scanResultToModify && 
                        scanResultToModify.propertyMapping && 
                        scanResultToModify.propertyMapping[propName] !== undefined) {
                        
                        const savedRaw = scanResultToModify.propertyMapping[propName];
                        if (savedRaw === 'No mapping') {
                            selectedPropRaw = null;
                            selectedPropDisplay = 'No mapping';
                        } else {
                            selectedPropRaw = savedRaw;
                            // Try to get a clean name if possible, or use raw
                            selectedPropDisplay = savedRaw.split('#')[0];
                        }
                        // console.log(`Restored mapping for ${cleanTargetName}: ${selectedPropDisplay}`);

                    } else if (sourceDefs) {
                        // Fallback: Try to find a property with the same clean name
                        const matchRaw = Object.keys(sourceDefs).find(p => p.split('#')[0] === cleanTargetName);
                        
                        if (matchRaw) {
                            selectedPropRaw = matchRaw;
                            selectedPropDisplay = matchRaw.split('#')[0];
                            
                            // Auto-save this default selection into the mapping?
                            // If we want the swap to reflect this default, we should save it.
                            if (scanResultToModify) {
                                if (!scanResultToModify.propertyMapping) scanResultToModify.propertyMapping = {};
                                scanResultToModify.propertyMapping[propName] = selectedPropRaw;
                            }
                        }
                    }

                    // Pre-check for available matching properties to set initial state
                    let hasMatchingProps = false;
                    const preCheckStrictType = (d) => {
                         if (d.type === 'VARIANT') {
                             const isBoolean = d.variantOptions && d.variantOptions.every(opt => ['true', 'false', 'on', 'off', 'yes', 'no'].includes(opt.toLowerCase()));
                             return isBoolean ? 'VARIANT_BOOLEAN' : 'VARIANT_STRING';
                         }
                         return d.type;
                    };
                    const targetStrictTypeRaw = preCheckStrictType(def);
                    
                    if (sourceDefs) {
                        for (const [sName, sDef] of Object.entries(sourceDefs)) {
                             if (sName.startsWith('__')) continue;
                             const sType = preCheckStrictType(sDef);
                             let isMatch = false;
                             if (targetStrictTypeRaw === 'TEXT' && sType === 'TEXT') isMatch = true;
                             else if (targetStrictTypeRaw === 'BOOLEAN' && sType === 'BOOLEAN') isMatch = true;
                             else if (targetStrictTypeRaw === 'VARIANT_BOOLEAN' && sType === 'VARIANT_BOOLEAN') isMatch = true;
                             else if (targetStrictTypeRaw === 'VARIANT_STRING' && sType === 'VARIANT_STRING') isMatch = true;
                             else if (targetStrictTypeRaw === 'INSTANCE_SWAP' && sType === 'INSTANCE_SWAP') isMatch = true;
                             else if (targetStrictTypeRaw === 'VARIANT' && (sType === 'VARIANT_BOOLEAN' || sType === 'VARIANT_STRING')) isMatch = true;
                             
                             if (isMatch) {
                                 hasMatchingProps = true;
                                 break;
                             }
                        }
                    }

                    if (!hasMatchingProps) {
                        selectedPropDisplay = 'Not available';
                        dropdown.classList.add('disabled');
                        dropdown.style.opacity = '0.5';
                        dropdown.style.pointerEvents = 'none';
                        dropdown.style.background = 'transparent';
                    }

                    dropdown.innerHTML = `
                        <div class="prop-dropdown-label-container">
                            <div class="prop-dropdown-label" title="${selectedPropRaw || ''}">${selectedPropDisplay}</div>
                        </div>
                        <svg class="chevron-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="${!hasMatchingProps ? 'display:none;' : ''}">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M9.64645 11.1464C9.84171 10.9512 10.1583 10.9512 10.3536 11.1464L12 12.7929L13.6464 11.1464C13.8417 10.9512 14.1583 10.9512 14.3536 11.1464C14.5488 11.3417 14.5488 11.6583 14.3536 11.8536L12.3536 13.8536C12.1583 14.0488 11.8417 14.0488 11.6464 13.8536L9.64645 11.8536C9.45118 11.6583 9.45118 11.3417 9.64645 11.1464Z" fill="currentColor" fill-opacity="0.9"/>
                        </svg>
                    `;
                    
                    // Add click handler to show actual menu
                    dropdown.onclick = (e) => {
                        e.stopPropagation();

                        const menu = document.getElementById('propMappingDropdownMenu');
                        if (menu && menu.style.display === 'block' && currentPropMappingTrigger === dropdown) {
                             menu.style.display = 'none';
                             currentPropMappingTrigger = null;
                             dropdown.classList.remove('active');
                             return;
                        }

                        // Determine strict type of target (def)
                        const getStrictType = (d) => {
                            if (d.type === 'VARIANT') {
                                const isBoolean = d.variantOptions && d.variantOptions.every(opt => ['true', 'false', 'on', 'off', 'yes', 'no'].includes(opt.toLowerCase()));
                                return isBoolean ? 'VARIANT_BOOLEAN' : 'VARIANT_STRING';
                            }
                            return d.type;
                        };
                        const targetStrictType = getStrictType(def);

                        showPropMappingMenu(dropdown, targetStrictType, sourceDefs, sourcePropertyValues, sourceLibraryName, sourceComponentName, (newSelectionRaw) => {
                            const newDisplay = newSelectionRaw === 'No mapping' ? 'No mapping' : newSelectionRaw.split('#')[0];
                            dropdown.querySelector('.prop-dropdown-label').textContent = newDisplay;
                            dropdown.querySelector('.prop-dropdown-label').title = newSelectionRaw;

                            // Save mapping to the current scan result object
                            if (scanResultToModify) {
                                if (!scanResultToModify.propertyMapping) {
                                    scanResultToModify.propertyMapping = {};
                                }
                                if (newSelectionRaw === 'No mapping') {
                                    delete scanResultToModify.propertyMapping[propName];
                                } else {
                                    scanResultToModify.propertyMapping[propName] = newSelectionRaw;
                                }
                                console.log('Saved mapping:', scanResultToModify.propertyMapping);
                            }
                        });
                    };
                    
                    rightCol.appendChild(dropdown);
                    
                    row.appendChild(leftCol);
                    row.appendChild(rightCol);
                    list.appendChild(row);
                });
            };

            // Render groups in order
            renderGroup('Variants', groups['VARIANT']);
            renderGroup('Booleans', groups['BOOLEAN']);
            renderGroup('Text', groups['TEXT']);
            renderGroup('Instance Swaps', groups['INSTANCE_SWAP']);
            renderGroup('Other', other);
        }
    }
    
    function showPropMappingMenu(trigger, type, sourceDefs, sourcePropertyValues, sourceLibraryName, sourceComponentName, onSelect) {
        // Reuse or create a global dropdown menu for mapping
        let menu = document.getElementById('propMappingDropdownMenu');
        if (!menu) {
            menu = document.createElement('div');
            menu.id = 'propMappingDropdownMenu';
            menu.className = 'dropdown-menu'; // Class triggers 'show' logic
            menu.style.position = 'fixed'; // ensure it floats
            document.body.appendChild(menu);
            
            // Close handler
           document.addEventListener('click', (e) => {
             if (menu.style.display === 'block' && !menu.contains(e.target)) {
               menu.style.display = 'none';
               if (currentPropMappingTrigger) {
                   currentPropMappingTrigger.classList.remove('active');
                   currentPropMappingTrigger = null;
               }
             }
           });
        }
        
        // Update active trigger state
        if (currentPropMappingTrigger && currentPropMappingTrigger !== trigger) {
            currentPropMappingTrigger.classList.remove('active');
        }
        currentPropMappingTrigger = trigger;
        currentPropMappingTrigger.classList.add('active');
        
        // Populate
        menu.innerHTML = '';
        
        // 1. Header Row
        const headerRow = document.createElement('div');
        headerRow.className = 'pm-menu-header';
        
        const headerTitle = document.createElement('div');
        headerTitle.className = 'pm-menu-title';
        headerTitle.style.display = 'flex';
        headerTitle.style.alignItems = 'center';
        
        // Component Icon
        const componentIcon = document.createElement('div');
        componentIcon.style.marginRight = '8px';
        componentIcon.style.display = 'flex';
        componentIcon.style.alignItems = 'center';
        componentIcon.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M8 5.83824L6.66041 4.5L8 3.16176L9.33959 4.5L8 5.83824ZM7.56946 2.17837L5.6796 4.06632C5.44013 4.30554 5.44013 4.69446 5.6796 4.93368L7.56946 6.82163C7.80753 7.05946 8.19247 7.05946 8.43054 6.82163L10.3204 4.93368C10.5599 4.69446 10.5599 4.30554 10.3204 4.06632L8.43054 2.17837C8.19247 1.94054 7.80753 1.94054 7.56946 2.17837ZM10.1618 8L11.5 6.66041L12.8382 8L11.5 9.33959L10.1618 8ZM9.17837 8.43054L11.0663 10.3204C11.3055 10.5599 11.6945 10.5599 11.9337 10.3204L13.8216 8.43054C14.0595 8.19247 14.0595 7.80753 13.8216 7.56946L11.9337 5.6796C11.6945 5.44013 11.3055 5.44013 11.0663 5.6796L9.17837 7.56946C8.94054 7.80753 8.94054 8.19247 9.17837 8.43054ZM6.66041 11.5L8 12.8382L9.33959 11.5L8 10.1618L6.66041 11.5ZM5.6796 11.0663L7.56946 9.17837C7.80753 8.94054 8.19247 8.94054 8.43054 9.17837L10.3204 11.0663C10.5599 11.3055 10.5599 11.6945 10.3204 11.9337L8.43054 13.8216C8.19247 14.0595 7.80753 14.0595 7.56946 13.8216L5.6796 11.9337C5.44013 11.6945 5.44013 11.3055 5.6796 11.0663ZM3.16176 8L4.5 6.66041L5.83824 8L4.5 9.33959L3.16176 8ZM2.17837 8.43054L4.06632 10.3204C4.30554 10.5599 4.69446 10.5599 4.93368 10.3204L6.82163 8.43054C7.05946 8.19247 7.05946 7.80753 6.82163 7.56946L4.93368 5.6796C4.69446 5.44013 4.30554 5.44013 4.06632 5.6796L2.17837 7.56946C1.94054 7.80753 1.94054 8.19247 2.17837 8.43054Z" fill="white" fill-opacity="1"/>
</svg>`;
        headerTitle.appendChild(componentIcon);
        
        const titleText = document.createElement('span');
        titleText.textContent = sourceComponentName || 'Source component';
        headerTitle.appendChild(titleText);
        
        headerRow.appendChild(headerTitle);
        
        const badge = document.createElement('div');
        badge.className = 'pm-menu-badge';
        // Icon 16 Library
        const badgeIcon = document.createElement('div');
        badgeIcon.style.width = '16px';
        badgeIcon.style.height = '16px';
        badgeIcon.style.display = 'flex';
        badgeIcon.style.alignItems = 'center';
        badgeIcon.style.justifyContent = 'center';
        badgeIcon.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M8 4.33282C6.67449 3.21952 4.72597 3.2412 3.42473 4.39786L3.16782 4.62622C3.06107 4.72111 3 4.85711 3 4.99993V11.9999C3 12.1968 3.11556 12.3754 3.29517 12.456C3.47479 12.5367 3.68502 12.5044 3.83218 12.3736L4.08909 12.1453C5.03631 11.3033 6.46369 11.3033 7.41091 12.1453L7.66782 12.3736C7.85726 12.542 8.14274 12.542 8.33218 12.3736L8.58909 12.1453C9.53631 11.3033 10.9637 11.3033 11.9109 12.1453L12.1678 12.3736C12.315 12.5044 12.5252 12.5367 12.7048 12.456C12.8844 12.3754 13 12.1968 13 11.9999V4.99993C13 4.85711 12.9389 4.72111 12.8322 4.62622L12.5753 4.39786C11.274 3.2412 9.32551 3.21952 8 4.33282ZM7.41091 5.14527C6.46369 4.3033 5.03631 4.3033 4.08909 5.14527L4 5.22446V10.9822C5.08026 10.3577 6.41974 10.3577 7.5 10.9822V5.22446L7.41091 5.14527ZM8.5 5.22446V10.9822C9.58026 10.3577 10.9197 10.3577 12 10.9822V5.22446L11.9109 5.14527C10.9637 4.3033 9.53631 4.3033 8.58909 5.14527L8.5 5.22446Z" fill="white" fill-opacity="1"/>
            </svg>`;
        badge.appendChild(badgeIcon);
        
        const badgeText = document.createElement('div');
        badgeText.className = 'pm-menu-badge-text';
        badgeText.textContent = sourceLibraryName || 'Library';
        badge.appendChild(badgeText);
        
        headerRow.appendChild(badge);
        menu.appendChild(headerRow);
        
        // 2. Divider
        const divider = document.createElement('div');
        divider.className = 'pm-menu-divider';
        divider.innerHTML = '<div class="pm-menu-divider-line"></div>';
        menu.appendChild(divider);
        
        // 3. Section Header - REMOVED per user request
        /*
        const sectionInfo = document.createElement('div');
        sectionInfo.className = 'pm-menu-section-header';
        sectionInfo.textContent = sourceComponentName || 'Source component';
        menu.appendChild(sectionInfo);
        */

        // 4. Option: "No mapping" & Items
        
        // Helper to determine strict type of Source properties
        const getStrictType = (d) => {
             if (d.type === 'VARIANT') {
                 const isBoolean = d.variantOptions && d.variantOptions.every(opt => ['true', 'false', 'on', 'off', 'yes', 'no'].includes(opt.toLowerCase()));
                 return isBoolean ? 'VARIANT_BOOLEAN' : 'VARIANT_STRING';
             }
             return d.type;
        };

        // Get current selected value
        let currentSelection = '';
        const labelEl = trigger.querySelector('.prop-dropdown-label');
        if (labelEl) {
             currentSelection = labelEl.getAttribute('title') || labelEl.textContent; // use title for raw value
        }

        const renderItem = (label, rawValue, itemType, defaultValue) => {
             const opt = document.createElement('div');
             opt.className = 'pm-menu-item';
             
             // Checkmark
             const check = document.createElement('div');
             check.className = 'pm-menu-item-check';
             if (currentSelection === rawValue || (rawValue === 'No mapping' && (!currentSelection || currentSelection === 'No mapping'))) {
                 check.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.7773 4.084C12.0071 4.23717 12.0692 4.54761 11.916 4.77737L7.91603 10.7774C7.83293 10.902 7.69834 10.9828 7.54927 10.9976C7.4002 11.0123 7.25237 10.9595 7.14645 10.8536L4.14645 7.85358C3.95118 7.65831 3.95118 7.34173 4.14645 7.14647C4.34171 6.95121 4.65829 6.95121 4.85355 7.14647L7.42229 9.7152L11.084 4.22267C11.2372 3.99291 11.5476 3.93082 11.7773 4.084Z" fill="currentColor" fill-opacity="0.9"/></svg>`;
             }
             opt.appendChild(check);
             
             // Icon (if not No mapping)
             const icon = document.createElement('div');
             icon.className = 'pm-menu-item-icon';
             if (rawValue !== 'No mapping') {
                 icon.innerHTML = getPropIcon(itemType); // This uses currentColor so it should inherit white
             }
             opt.appendChild(icon);
             
             // Text
             const text = document.createElement('div');
             text.className = 'pm-menu-item-text';
             text.textContent = label;
             opt.appendChild(text);

             // Default Value (Right Aligned)
             if (defaultValue !== undefined && defaultValue !== null) {
                 const valueDiv = document.createElement('div');
                 valueDiv.className = 'pm-menu-item-value';
                 valueDiv.style.color = 'var(--figma-color-text-secondary, rgba(255,255,255,0.7))';
                 valueDiv.style.fontSize = '11px';
                 valueDiv.style.marginLeft = '8px';
                 valueDiv.style.whiteSpace = 'nowrap';
                 // Format boolean values
                 let displayVal = String(defaultValue);
                 if (getStrictType({type: itemType, variantOptions: []}) === 'VARIANT_BOOLEAN' || itemType === 'BOOLEAN') {
                     if (displayVal.toLowerCase() === 'true') displayVal = 'On';
                     if (displayVal.toLowerCase() === 'false') displayVal = 'Off';
                 }
                 valueDiv.textContent = displayVal;
                 opt.appendChild(valueDiv);
             }
             
             opt.onclick = () => {
                 onSelect(rawValue);
                 menu.style.display = 'none';
                 if (currentPropMappingTrigger) {
                     currentPropMappingTrigger.classList.remove('active');
                     currentPropMappingTrigger = null;
                 }
             };
             menu.appendChild(opt);
        };
        
        // renderItem('No mapping', 'No mapping', null); // Removed per user request

        let hasItems = false;

        // Filter logic determined by usage in renderPropertyMappingView
        if (sourceDefs) {
             const items = [];
             Object.entries(sourceDefs).forEach(([pName, pDef]) => {
                 if (pName.startsWith('__')) return;
                 
                 const sourceStrictType = getStrictType(pDef);
                 /*
                  Filtering Logic:
                  type (targetStrictType) -> sourceStrictType
                  
                  STRING (TEXT) -> TEXT
                  BOOLEAN -> BOOLEAN
                  VARIANT_BOOLEAN -> VARIANT_BOOLEAN
                  VARIANT_STRING -> VARIANT_STRING
                  INSTANCE_SWAP -> INSTANCE_SWAP (Presumed)
                 */
                 
                 let isMatch = false;
                 // Type is passed as targetStrictType or normal type
                 if (type === 'TEXT' && sourceStrictType === 'TEXT') isMatch = true;
                 else if (type === 'BOOLEAN' && sourceStrictType === 'BOOLEAN') isMatch = true;
                 else if (type === 'VARIANT_BOOLEAN' && sourceStrictType === 'VARIANT_BOOLEAN') isMatch = true;
                 else if (type === 'VARIANT_STRING' && sourceStrictType === 'VARIANT_STRING') isMatch = true;
                 else if (type === 'INSTANCE_SWAP' && sourceStrictType === 'INSTANCE_SWAP') isMatch = true;
                 
                 // If it's a generic VARIANT type passed (fallback), match any VARIANT
                 else if (type === 'VARIANT' && (sourceStrictType === 'VARIANT_BOOLEAN' || sourceStrictType === 'VARIANT_STRING')) isMatch = true;
                 
                 if (isMatch) {
                    items.push({ name: pName, def: pDef });
                 }
             });

             if (items.length > 0) hasItems = true;

             // Sort items by name
             items.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                 const cleanName = item.name.split('#')[0];
                 // Lookup actual value from sourcePropertyValues if available, else fallback to def default
                 let actualValue = item.def.defaultValue;
                 if (sourcePropertyValues && sourcePropertyValues[item.name]) {
                     actualValue = sourcePropertyValues[item.name].value;
                 }
                 renderItem(cleanName, item.name, item.def.type, actualValue);
             });
        }
        
        if (!hasItems) {
             const emptyOpt = document.createElement('div');
             emptyOpt.className = 'pm-menu-item';
             emptyOpt.style.cursor = 'default';
             emptyOpt.style.color = 'var(--figma-color-text-secondary, rgba(255,255,255,0.5))';
             emptyOpt.style.fontStyle = 'italic';
             emptyOpt.textContent = 'No matching properties';
             menu.appendChild(emptyOpt);
        }
        
        // Position with collision detection
        const rect = trigger.getBoundingClientRect();
        
        // Show temporarily to measure
        menu.style.display = 'block';
        menu.style.visibility = 'hidden';
        
        const menuHeight = menu.offsetHeight;
        const windowHeight = window.innerHeight;
        const windowWidth = window.innerWidth;
        
        // Align left with trigger, but keep in bounds
        let left = rect.left;
        if (left + 240 > windowWidth) {
            left = windowWidth - 250; 
        }
        menu.style.left = left + 'px';
        menu.style.width = '240px'; 
        
        if (rect.bottom + menuHeight > windowHeight && rect.top > menuHeight) {
             // Show above
             menu.style.top = (rect.top - menuHeight - 4) + 'px';
             menu.style.maxHeight = (rect.top - 10) + 'px';
        } else {
             // Show below
             menu.style.top = (rect.bottom + 4) + 'px';
             menu.style.maxHeight = (windowHeight - rect.bottom - 10) + 'px';
        }
        
        menu.style.visibility = 'visible';
    }

    function getPropIcon(type) {
        // Simple SVGs
        if (type === 'BOOLEAN') return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10 8H14C16.2091 8 18 9.79086 18 12C18 14.2091 16.2091 16 14 16H10C7.79086 16 6 14.2091 6 12C6 9.79086 7.79086 8 10 8ZM5 12C5 9.23857 7.23857 7 10 7H14C16.7614 7 19 9.23857 19 12C19 14.7614 16.7614 17 14 17H10C7.23857 17 5 14.7614 5 12ZM10 14C8.89543 14 8 13.1046 8 12C8 10.8954 8.89543 10 10 10C11.1046 10 12 10.8954 12 12C12 13.1046 11.1046 14 10 14ZM7 12C7 10.3431 8.34314 9 10 9C11.6569 9 13 10.3431 13 12C13 13.6569 11.6569 15 10 15C8.34314 15 7 13.6569 7 12Z" fill="currentColor" fill-opacity="0.9"/></svg>';
        if (type === 'TEXT') return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 7H16C16.5523 7 17 7.44771 17 8V16C17 16.5523 16.5523 17 16 17H8C7.44771 17 7 16.5523 7 16V8C7 7.44771 7.44771 7 8 7ZM6 8C6 6.89543 6.89543 6 8 6H16C17.1046 6 18 6.89543 18 8V16C18 17.1046 17.1046 18 16 18H8C6.89543 18 6 17.1046 6 16V8ZM9.5 9C9.22386 9 9 9.22386 9 9.5V10.5C9 10.7761 9.22386 11 9.5 11C9.77614 11 10 10.7761 10 10.5V10H11.5V14H11C10.7239 14 10.5 14.2239 10.5 14.5C10.5 14.7761 10.7239 15 11 15H13C13.2761 15 13.5 14.7761 13.5 14.5C13.5 14.2239 13.2761 14 13 14H12.5V10H14V10.5C14 10.7761 14.2239 11 14.5 11C14.7761 11 15 10.7761 15 10.5V9.5C15 9.22386 14.7761 9 14.5 9H9.5Z" fill="currentColor" fill-opacity="0.9"/></svg>';
        if (type === 'INSTANCE_SWAP') return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 6C6.22386 6 6 6.22386 6 6.5V9.5C6 9.77614 6.22386 10 6.5 10C6.77614 10 7 9.77614 7 9.5V7H9.5C9.77614 7 10 6.77614 10 6.5C10 6.22386 9.77614 6 9.5 6H6.5Z" fill="currentColor" fill-opacity="0.9"/><path d="M14.5 6C14.2239 6 14 6.22386 14 6.5C14 6.77614 14.2239 7 14.5 7H17V9.5C17 9.77614 17.2239 10 17.5 10C17.7761 10 18 9.77614 18 9.5V6.5C18 6.22386 17.7761 6 17.5 6H14.5Z" fill="currentColor" fill-opacity="0.9"/><path d="M7 14.5C7 14.2239 6.77614 14 6.5 14C6.22386 14 6 14.2239 6 14.5V17.5C6 17.7761 6.22386 18 6.5 18H9.5C9.77614 18 10 17.7761 10 17.5C10 17.2239 9.77614 17 9.5 17H7V14.5Z" fill="currentColor" fill-opacity="0.9"/><path d="M18 14.5C18 14.2239 17.7761 14 17.5 14C17.2239 14 17 14.2239 17 14.5V17H14.5C14.2239 17 14 17.2239 14 17.5C14 17.7761 14.2239 18 14.5 18H17.5C17.7761 18 18 17.7761 18 17.5V14.5Z" fill="currentColor" fill-opacity="0.9"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12.3535 8.64645C12.1583 8.45119 11.8417 8.45119 11.6465 8.64645L8.64645 11.6465C8.45119 11.8417 8.45119 12.1583 8.64645 12.3535L11.6465 15.3535C11.8417 15.5488 12.1583 15.5488 12.3535 15.3535L15.3535 12.3535C15.5488 12.1583 15.5488 11.8417 15.3535 11.6465L12.3535 8.64645ZM12 14.2929L9.70711 12L12 9.70711L14.2929 12L12 14.2929Z" fill="currentColor" fill-opacity="0.9"/></svg>';
        if (type === 'VARIANT') return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.1162 5.8837L5.88394 11.1159C5.39578 11.6041 5.39578 12.3955 5.88394 12.8837L11.1162 18.1159C11.6043 18.6041 12.3958 18.6041 12.8839 18.1159L18.1162 12.8837C18.6043 12.3955 18.6043 11.6041 18.1162 11.1159L12.8839 5.88369C12.3958 5.39554 11.6043 5.39554 11.1162 5.8837ZM11.8233 6.5908L6.59105 11.823C6.49341 11.9207 6.49341 12.079 6.59105 12.1766L11.8233 17.4088C11.9209 17.5065 12.0792 17.5065 12.1768 17.4088L17.4091 12.1766C17.5067 12.079 17.5067 11.9207 17.4091 11.823L12.1768 6.5908C12.0792 6.49317 11.9209 6.49317 11.8233 6.5908Z" fill="currentColor" fill-opacity="0.9"/></svg>';
        return '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="4" stroke="currentColor"/></svg>';
        return '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="4" stroke="currentColor"/></svg>';
    }

    // Initialize Back Button
    const backMappingBtn = document.getElementById('backToScanFromMapping');
    if (backMappingBtn) {
        backMappingBtn.onclick = () => {
             // Return to scan view
             showView('scanResultsView');
        }
    }
  </script>
